{% extends "base.html" %}

{% block title %}Изображение для сюжета — Paperbird{% endblock %}

{% block extra_head %}
<style>
  .image-studio {
    display: grid;
    grid-template-columns: 4fr 3fr;
    gap: 1.5rem;
  }
  @media (max-width: 992px) {
    .image-studio {
      grid-template-columns: 1fr;
    }
  }
  .preview-area {
    position: sticky;
    top: 1rem;
  }
  .preview-area .card-img-top {
    max-height: 280px;
    width: 100%;
    object-fit: contain;
    background-color: #f8f9fa;
  }
  .preview-clickable {
    cursor: zoom-in;
  }
  .preview-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #adb5bd;
      min-height: 250px;
      text-align: center;
  }
  .preview-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    color: #6c757d;
    text-align: center;
  }
  .source-media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
  }
  .source-media-item {
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s ease;
  }
  .source-media-item:hover, .source-media-item.selected {
      border-color: var(--bs-primary);
  }
  #upload-drop-zone {
    border: 2px dashed #ced4da;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #upload-drop-zone:hover, #upload-drop-zone.dragover {
    background-color: #e9ecef;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-3">
  <a href="{% url 'stories:detail' story.pk %}" class="link-secondary">← Назад к сюжету</a>
</div>

<h1 class="h3 mb-3">Изображение для сюжета</h1>
<p class="text-muted">{{ story.title|default:"Сюжет без названия" }} — {{ story.project.name }}</p>

<div class="image-studio">
  <!-- Left Column: Tabs -->
  <div class="actions-area">
    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="imageSourceTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate" type="button" role="tab" aria-controls="generate" aria-selected="true">Генерация</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="source-media-tab" data-bs-toggle="tab" data-bs-target="#source-media" type="button" role="tab" aria-controls="source-media" aria-selected="false">Медиа из постов</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="false">Загрузить</button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="imageSourceTabsContent">
                <!-- Generate Tab -->
                <div class="tab-pane fade show active" id="generate" role="tabpanel">
                    <form id="image-generate-form">
                        {% csrf_token %}
                        <div class="mb-3">
                          {{ generate_form.prompt.label_tag }}
                          {{ generate_form.prompt }}
                          {% if generate_form.prompt.errors %}<div class="text-danger small mt-1">{{ generate_form.prompt.errors|join:', ' }}</div>{% endif %}
                          <div class="border rounded p-2 mt-2 bg-light-subtle">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                              <span class="small text-muted">Рекомендуемый промпт</span>
                              <button type="button" class="btn btn-sm btn-outline-secondary" id="use-recommended-prompt" disabled>
                                Использовать
                              </button>
                            </div>
                            <p class="small text-muted mb-2" id="recommended-prompt-text">
                              Загрузка рекомендации...
                            </p>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-recommended-prompt">
                              <i class="bi bi-arrow-clockwise"></i>
                              Обновить
                            </button>
                          </div>
                        </div>
                        <div class="row g-3">
                          <div class="col-md-4">{{ generate_form.model.label_tag }}{{ generate_form.model }}</div>
                          <div class="col-md-4" id="size-field">
                            {{ generate_form.size.label_tag }}{{ generate_form.size }}
                          </div>
                          <div class="col-md-4" id="quality-field">
                            {{ generate_form.quality.label_tag }}{{ generate_form.quality }}
                          </div>
                          <div class="col-md-4 d-none" id="aspect-ratio-field">
                            {{ generate_form.aspect_ratio.label_tag }}
                            {{ generate_form.aspect_ratio }}
                          </div>
                          <div class="col-md-4 d-none" id="image-size-field">
                            {{ generate_form.image_size.label_tag }}
                            {{ generate_form.image_size }}
                          </div>
                        </div>
                        <button class="btn btn-primary mt-3" type="submit"><i class="bi bi-magic me-1"></i> Сгенерировать</button>
                    </form>
                </div>
                <!-- Source Media Tab -->
                <div class="tab-pane fade" id="source-media" role="tabpanel">
                    <p class="small text-muted">Выберите изображение из исходных постов сюжета, чтобы поместить его в предпросмотр.</p>
                    {% if source_media %}
                        <div class="source-media-grid">
                            {% for item in source_media %}
                            <div class="source-media-item rounded p-2" data-url="{{ item.url }}" data-post-id="{{ item.post.id }}" data-mime="{{ item.mime }}">
                                <img src="{{ item.url }}" alt="Медиа поста" class="img-fluid rounded">
                                <div class="small text-muted mt-1">Пост #{{ item.post.id }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">В исходных постах сюжета нет изображений.</div>
                    {% endif %}
                </div>
                <!-- Upload Tab -->
                <div class="tab-pane fade" id="upload" role="tabpanel">
                    <form id="image-upload-form">
                        {% csrf_token %}
                        <div id="upload-drop-zone">
                            <p class="mb-0">Перетащите файл сюда или нажмите для выбора</p>
                            <p class="small text-muted mb-0">PNG, JPG, WEBP</p>
                            <input type="file" name="image_file" id="id_image_file" class="d-none" accept="image/png,image/jpeg,image/webp">
                        </div>
                        {% if upload_form.image_file.errors %}<div class="text-danger small mt-1">{{ upload_form.image_file.errors|join:', ' }}</div>{% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- Right Column: Preview -->
  <div class="preview-area">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h6 mb-0">Предпросмотр</h2>
            {% if story.image_file %}
            <form id="remove-form" method="post" class="mb-0">
                {% csrf_token %}<input type="hidden" name="action" value="remove" />{{ delete_form.confirm }}
                <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
            </form>
            {% endif %}
        </div>
        <div class="preview-placeholder">
            {% if story.image_file %}
                <img src="{{ story.image_file.url }}" id="preview-image" class="card-img-top preview-clickable" alt="Текущее изображение" data-full-src="{{ story.image_file.url }}">
            {% else %}
                <i class="bi bi-image h1"></i>
            {% endif %}
        </div>
        <div class="card-body">
            <p id="preview-prompt" class="small text-muted">{% if story.image_prompt %}{{ story.image_prompt }}{% else %}Здесь будет показан промпт или имя файла.{% endif %}</p>
        </div>
        <div class="card-footer bg-light">
             <form id="attach-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="attach">
                <div id="attach-form-fields"></div>
                <button id="attach-button" type="submit" class="btn btn-success w-100" disabled>
                    <i class="bi bi-paperclip me-1"></i>
                    Прикрепить к сюжету
                </button>
            </form>
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="previewImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-6">Полный просмотр</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="preview-modal-image" src="" alt="Полный размер" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const previewPlaceholder = document.querySelector('.preview-placeholder');
    const previewPrompt = document.getElementById('preview-prompt');
    const attachButton = document.getElementById('attach-button');
    const attachFormFields = document.getElementById('attach-form-fields');
    const recommendedText = document.getElementById('recommended-prompt-text');
    const recommendedUseButton = document.getElementById('use-recommended-prompt');
    const recommendedRefreshButton = document.getElementById('refresh-recommended-prompt');
    const promptInput = document.getElementById('id_prompt');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    let recommendedValue = '';

    const imageProviderSettings = JSON.parse('{{ image_provider_settings|escapejs }}');
    const modelSelect = document.getElementById('id_model');
    const sizeSelect = document.getElementById('id_size');
    const qualitySelect = document.getElementById('id_quality');
    const aspectRatioSelect = document.getElementById('id_aspect_ratio');
    const imageSizeSelect = document.getElementById('id_image_size');
    const sizeField = document.getElementById('size-field');
    const qualityField = document.getElementById('quality-field');
    const aspectRatioField = document.getElementById('aspect-ratio-field');
    const imageSizeField = document.getElementById('image-size-field');

    function updateSelect(select, options, defaultValue, emptyLabel) {
        if (!select) return;
        select.innerHTML = '';
        if (emptyLabel !== null) {
            select.add(new Option(emptyLabel, ''));
        }
        options.forEach(optionValue => {
            const option = new Option(optionValue, optionValue);
            select.add(option);
        });
        if (defaultValue !== undefined && defaultValue !== null && defaultValue !== '') {
            select.value = defaultValue;
        }
    }

    function updateGenerationOptions() {
        const selectedModel = modelSelect.value || 'default';
        const settings = imageProviderSettings[selectedModel] || imageProviderSettings['default'];
        const isGemini = settings.kind === 'gemini';

        // Update sizes
        updateSelect(sizeSelect, settings.sizes || [], settings.default_size, null);

        // Update qualities
        updateSelect(qualitySelect, settings.qualities || [], settings.default_quality, null);

        // Update Gemini options
        const aspectRatios = settings.aspect_ratios || [];
        const imageSizes = settings.image_sizes || [];

        updateSelect(
            aspectRatioSelect,
            aspectRatios,
            settings.default_aspect_ratio,
            'По умолчанию'
        );
        updateSelect(
            imageSizeSelect,
            imageSizes,
            settings.default_image_size,
            'По умолчанию'
        );

        if (sizeField) sizeField.classList.toggle('d-none', isGemini);
        if (qualityField) qualityField.classList.toggle('d-none', isGemini);
        const hasAspectRatios = aspectRatios.length > 0;
        const hasImageSizes = imageSizes.length > 0;

        if (aspectRatioField) {
            aspectRatioField.classList.toggle('d-none', !isGemini || !hasAspectRatios);
        }
        if (imageSizeField) {
            imageSizeField.classList.toggle('d-none', !isGemini || !hasImageSizes);
        }

        if (sizeSelect) sizeSelect.disabled = isGemini;
        if (qualitySelect) qualitySelect.disabled = isGemini;
        if (aspectRatioSelect) aspectRatioSelect.disabled = !isGemini || !hasAspectRatios;
        if (imageSizeSelect) imageSizeSelect.disabled = !isGemini || !hasImageSizes;
    }

    if (modelSelect && sizeSelect && qualitySelect && imageProviderSettings) {
        modelSelect.addEventListener('change', updateGenerationOptions);
        // Initial population
        updateGenerationOptions();
    }
    
    // --- Generic Fetch Handler ---
    function performAction(formData) {
        const action = formData.get('action');
        let body;
        let headers = { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken.value };

        if (formData.has('image_file')) {
            body = formData;
            // Let the browser set the Content-Type for multipart/form-data
        } else {
            body = new URLSearchParams(formData);
        }

        let loadingMessage = 'Выполняется...';
        if (action === 'generate') loadingMessage = 'Генерация изображения...';
        if (action === 'upload') loadingMessage = 'Загрузка файла...';

        showLoading(loadingMessage);

        return fetch(window.location.href, { method: 'POST', body: body, headers: headers })
            .then(async (response) => {
                const data = await response.json().catch(() => null);
                if (!response.ok || !data) {
                    const message = data && data.message ? data.message : `Ошибка выполнения действия: ${action}.`;
                    throw new Error(message);
                }
                return data;
            })
            .then(data => {
                if (data.status === 'success' && data.preview) {
                    updatePreview(data.preview.data, data.preview.mime, data.preview.prompt);
                    prepareAttachForm(data.preview);
                    hideLoading();
                } else {
                    showError(data.message || `Ошибка выполнения: ${action}.`);
                }
            })
            .catch((err) => showError(err.message || 'Сетевая ошибка.'));
    }

    // --- Generate Form ---
    const generateForm = document.getElementById('image-generate-form');
    generateForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('action', 'generate');
        performAction(formData);
    });

    // --- Recommended Prompt ---
    function applyRecommendation(value, errorMessage) {
        if (!recommendedText) return;
        recommendedValue = value || '';
        if (recommendedValue) {
            recommendedText.textContent = recommendedValue;
            recommendedUseButton.disabled = false;
        } else {
            recommendedText.textContent = errorMessage || 'Не удалось получить рекомендацию.';
            recommendedUseButton.disabled = true;
        }
    }

    function fetchRecommendedPrompt() {
        if (!recommendedText || !csrfToken) return;
        recommendedText.textContent = 'Генерация...';
        recommendedUseButton.disabled = true;

        const formData = new FormData();
        formData.append('action', 'suggest_prompt');
        formData.append('csrfmiddlewaretoken', csrfToken.value);

        fetch(window.location.href, {
            method: 'POST',
            body: new URLSearchParams(formData),
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken.value }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.message || 'Ошибка сети');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' && data.prompt) {
                applyRecommendation(data.prompt);
            } else {
                applyRecommendation(null, data.message || 'Не удалось получить рекомендацию.');
            }
        })
        .catch((err) => applyRecommendation(null, err.message));
    }

    recommendedRefreshButton.addEventListener('click', fetchRecommendedPrompt);
    recommendedUseButton.addEventListener('click', () => {
        if (promptInput && recommendedValue) {
            promptInput.value = recommendedValue;
        }
    });

    // Auto-fetch on load
    fetchRecommendedPrompt();

    // --- Source Media Tab ---
    document.querySelectorAll('.source-media-item').forEach(item => {
        item.addEventListener('click', function() {
            const url = this.dataset.url;
            const mime = this.dataset.mime;
            const postId = this.dataset.postId;
            
            document.querySelectorAll('.source-media-item').forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            showLoading(`Загрузка медиа из поста #${postId}...`);

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить изображение.');
                    return response.blob();
                })
                .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64data = reader.result.split(',')[1];
                        const previewData = {
                            data: base64data,
                            mime: mime || blob.type,
                            prompt: `Изображение из поста #${postId}`,
                        };
                        updatePreview(previewData.data, previewData.mime, previewData.prompt);
                        prepareAttachForm(previewData);
                        hideLoading();
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(err => showError(err.message));
        });
    });

    // --- Upload Tab ---
    const uploadDropZone = document.getElementById('upload-drop-zone');
    const uploadInput = document.getElementById('id_image_file');
    
    uploadDropZone.addEventListener('click', () => uploadInput.click());
    
    function handleFiles(files) {
        const file = files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('action', 'upload');
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        formData.append('image_file', file);
        performAction(formData);
    }

    uploadInput.addEventListener('change', () => handleFiles(uploadInput.files));
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadDropZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadDropZone.addEventListener(eventName, () => uploadDropZone.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        uploadDropZone.addEventListener(eventName, () => uploadDropZone.classList.remove('dragover'), false);
    });
    uploadDropZone.addEventListener('drop', (e) => {
        handleFiles(e.dataTransfer.files);
    }, false);


    // --- Helper Functions ---
    function updatePreview(base64Data, mimeType, promptText) {
        const imgSrc = `data:${mimeType};base64,${base64Data}`;
        let imageNode = document.getElementById('preview-image');
        if (!imageNode) {
            imageNode = document.createElement('img');
            imageNode.id = 'preview-image';
            imageNode.className = 'card-img-top preview-clickable';
            previewPlaceholder.innerHTML = '';
            previewPlaceholder.appendChild(imageNode);
        }
        imageNode.src = imgSrc;
        imageNode.setAttribute('data-full-src', imgSrc);
        if (previewPrompt) {
            previewPrompt.textContent = promptText;
        }
    }

    function prepareAttachForm(previewData) {
        let fieldsHtml = '';
        const promptValue = previewData.prompt || (promptInput && promptInput.value) || '';
        
        const dataToAttach = { ...previewData, prompt: promptValue };

        for (const [key, value] of Object.entries(dataToAttach)) {
            if (key !== 'data' && key !== 'mime') {
                fieldsHtml += `<input type="hidden" name="${key}" value="${escapeHtml(value)}">`;
            }
        }
        if (dataToAttach.preview_token) {
            fieldsHtml += `<input type="hidden" name="preview_token" value="${escapeHtml(dataToAttach.preview_token)}">`;
        } else {
            fieldsHtml += `<input type="hidden" name="image_data" value="${dataToAttach.data}">`;
        }
        fieldsHtml += `<input type="hidden" name="mime_type" value="${dataToAttach.mime}">`;
        
        attachFormFields.innerHTML = fieldsHtml;
        attachButton.disabled = false;
    }

    function showLoading(message) {
        previewPlaceholder.innerHTML = `<div class="preview-status"><div class="spinner-border text-primary" role="status"></div><div class="small">${message}</div></div>`;
        attachButton.disabled = true;
    }

    function showError(message) {
        previewPlaceholder.innerHTML = `<div class="preview-status text-danger"><i class="bi bi-exclamation-triangle-fill h3"></i><div class="small">${message}</div></div>`;
    }
    
    function hideLoading() {
        const currentImage = document.getElementById('preview-image');
        if (!currentImage && previewPlaceholder) {
            previewPlaceholder.innerHTML = '<i class="bi bi-image h1"></i>';
        }
    }
    
    function escapeHtml(text) {
        if(typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.innerText = text;
        return div.innerHTML;
    }

    // --- Modal Logic ---
    const previewModal = document.getElementById('previewImageModal');
    const previewModalImage = document.getElementById('preview-modal-image');
    previewPlaceholder.addEventListener('click', (event) => {
        const target = event.target;
        if (!target || target.id !== 'preview-image' || !previewModalImage) return;
        const src = target.getAttribute('data-full-src') || target.src;
        previewModalImage.src = src;
        if (window.bootstrap && previewModal) {
            const modal = window.bootstrap.Modal.getOrCreateInstance(previewModal);
            modal.show();
        }
    });

    if (previewModal) {
        previewModal.addEventListener('hidden.bs.modal', () => {
            if (previewModalImage) {
                previewModalImage.src = '';
            }
        });
    }

    if (promptInput) {
        promptInput.addEventListener('input', () => {
            const hiddenPrompt = attachFormFields.querySelector('input[name="prompt"]');
            if (hiddenPrompt) {
                hiddenPrompt.value = promptInput.value;
            }
        });
    }
});
</script>
{% endblock %}
