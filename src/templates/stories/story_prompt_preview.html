{% extends "base.html" %}

{% block title %}Промпт рерайта — Paperbird{% endblock %}

{% block content %}
  <div class="mb-4">
    <a class="btn btn-link ps-0" href="{% url 'stories:detail' story.pk %}">← Назад к сюжету</a>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <h1 class="h4 mb-3">Проверьте промпт перед отправкой</h1>
      <p class="text-muted">Отредактируйте текст ниже, если нужно скорректировать запрос к модели.</p>
      <dl class="row small text-muted">
        <dt class="col-sm-3">Сюжет</dt>
        <dd class="col-sm-9">{{ story.title|default:"Без названия" }}</dd>
        {% if preset %}
          <dt class="col-sm-3">Пресет</dt>
          <dd class="col-sm-9">{{ preset.name }}</dd>
        {% endif %}
        {% if editor_comment %}
          <dt class="col-sm-3">Комментарий редактора</dt>
          <dd class="col-sm-9">{{ editor_comment|linebreaksbr }}</dd>
        {% endif %}
      </dl>
      <form method="post" action="{% url 'stories:detail' story.pk %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="rewrite" />
        <input type="hidden" name="prompt_confirm" value="1" />
        {{ prompt_form.preset }}
        {{ prompt_form.editor_comment }}
        {% if prompt_form.non_field_errors %}
          <div class="alert alert-danger">{{ prompt_form.non_field_errors }}</div>
        {% endif %}
        <div class="mb-3">
          <label class="form-label" for="{{ prompt_form.prompt_system.id_for_label }}">
            {{ prompt_form.prompt_system.label }}
          </label>
          {{ prompt_form.prompt_system }}
          <div class="form-text">Базовые инструкции для модели.</div>
          {% if prompt_form.prompt_system.errors %}
            <div class="text-danger small">{{ prompt_form.prompt_system.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="mb-3">
          <label class="form-label" for="{{ prompt_form.prompt_user.id_for_label }}">
            {{ prompt_form.prompt_user.label }}
          </label>
          {{ prompt_form.prompt_user }}
          <div class="form-text">Итоговый запрос с выбранными постами и инструкциями.</div>
          {% if prompt_form.prompt_user.errors %}
            <div class="text-danger small">{{ prompt_form.prompt_user.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" type="submit">Запустить рерайт</button>
          <a class="btn btn-outline-secondary" href="{% url 'stories:detail' story.pk %}">Отмена</a>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
