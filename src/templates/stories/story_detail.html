{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ story.title|default:"Сюжет" }} — Paperbird{% endblock %}

{% block content %}
  <div class="mb-4">
    <div class="d-flex flex-wrap justify-content-between gap-3 align-items-start">
      <div>
        <h1 class="h3 mb-1">{{ story.title|default:"Сюжет без названия" }}</h1>
        <p class="text-muted mb-0">
          Проект: {{ story.project.name }} •
          Статус: <span class="badge text-bg-secondary">{{ story.get_status_display }}</span>
        </p>
        {% if last_task %}
          <p class="small text-muted mt-1 mb-0">
            Последний рерайт: {{ last_task.created_at|naturaltime }}
            ({{ last_task.get_status_display }})
          </p>
        {% endif %}
      </div>
      <a class="btn btn-outline-secondary" href="{% url 'stories:list' %}">
        <i class="bi bi-arrow-left me-1"></i>К списку сюжетов
      </a>
    </div>
  </div>

  <div class="accordion shadow-sm" id="story-accordion">
    {# Step 1: Sources #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-sources">
        <button class="accordion-button {% if active_step != 'sources' %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-sources" aria-expanded="{% if active_step == 'sources' %}true{% else %}false{% endif %}" aria-controls="collapse-sources">
          <span class="badge text-bg-primary me-3">Шаг 1</span>
          Исходные новости
        </button>
      </h2>
      <div id="collapse-sources" class="accordion-collapse collapse {% if active_step == 'sources' %}show{% endif %}" aria-labelledby="heading-sources" data-bs-parent="#story-accordion">
        <div class="accordion-body">
          {% if story_posts %}
            {% for story_post in story_posts %}
              <div class="card mb-3">
                <div class="card-body">
                  <div class="d-flex w-100 justify-content-between">
                    <h3 class="h6 mb-1">
                      {% if story_post.post.origin_type == "telegram" %}
                        <i class="bi bi-telegram text-info"></i> Пост #{{ story_post.post.telegram_id|default:"—" }}
                      {% else %}
                        <i class="bi bi-globe2 text-success"></i> Веб-материал
                      {% endif %}
                    </h3>
                    <small class="text-muted">{{ story_post.post.posted_at|naturaltime }}</small>
                  </div>
                  <p class="small text-muted mb-2">
                    {{ story_post.post.source.title|default:story_post.post.source.username }}
                  </p>
                  <p class="mb-0">{{ story_post.post.message|default:""|linebreaksbr }}</p>
                  {% with media_items=story_post.post.media_items %}
                    {% if media_items %}
                      <div class="mt-3 d-flex flex-wrap gap-2">
                        {% for item in media_items %}
                          <a href="{{ item.url }}" target="_blank" rel="noopener" class="border rounded overflow-hidden d-flex align-items-center justify-content-center" style="width: 100px; height: 75px;">
                            {% if item.kind == "video" %}
                              <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-body-secondary text-muted">
                                <div class="fs-4 lh-1">▶</div>
                              </div>
                            {% else %}
                              <img src="{{ item.url }}" alt="Медиа поста" loading="lazy" class="img-fluid h-100 w-100 object-fit-cover" />
                            {% endif %}
                          </a>
                        {% endfor %}
                      </div>
                    {% endif %}
                  {% endwith %}
                  {% if story_post.post.external_link %}
                    <a href="{{ story_post.post.external_link }}" target="_blank" rel="noopener" class="small mt-2 d-block">Оригинал <i class="bi bi-box-arrow-up-right"></i></a>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Сюжет пока без постов.</p>
          {% endif %}
        </div>
      </div>
    </div>

    {# Step 2: Rewrite #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-prompt">
        <button class="accordion-button {% if active_step != 'prompt' %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-prompt" aria-expanded="{% if active_step == 'prompt' %}true{% else %}false{% endif %}" aria-controls="collapse-prompt">
          <span class="badge text-bg-primary me-3">Шаг 2</span>
          Подготовка рерайта
        </button>
      </h2>
      <div id="collapse-prompt" class="accordion-collapse collapse {% if active_step == 'prompt' %}show{% endif %}" aria-labelledby="heading-prompt" data-bs-parent="#story-accordion">
        <div class="accordion-body">
          <div id="rewrite-progress" class="alert alert-info d-flex align-items-center {% if story.status != 'rewriting' %}d-none{% endif %}" role="status" data-active="{% if story.status == 'rewriting' %}1{% else %}0{% endif %}">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>Рерайт выполняется <span class="fw-semibold" data-role="timer">0</span> с...</span>
          </div>
          <form method="post" id="rewrite-form" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="rewrite" />
            <div class="mb-3">
              <label for="{{ rewrite_form.editor_comment.id_for_label }}" class="form-label">{{ rewrite_form.editor_comment.label }}</label>
              {{ rewrite_form.editor_comment }}
              <div class="form-text">Добавьте инструкции для рерайта (опционально).</div>
            </div>
            <button class="btn btn-primary" type="submit" data-role="rewrite-submit" {% if story.status == 'rewriting' %}disabled{% endif %}>
              <i class="bi bi-magic"></i> Запустить рерайт
            </button>
          </form>
          <div class="accordion" id="prompt-details-accordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-prompt-details">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-prompt-details" aria-expanded="false" aria-controls="collapse-prompt-details">
                  <i class="bi bi-robot me-2"></i> Промпт для модели (для контроля)
                </button>
              </h2>
              <div id="collapse-prompt-details" class="accordion-collapse collapse" aria-labelledby="heading-prompt-details" data-bs-parent="#prompt-details-accordion">
                <div class="accordion-body bg-light-subtle">
                  <div class="row g-3">
                    <div class="col-12 col-lg-4">
                      <label class="form-label small">System prompt</label>
                      <textarea class="form-control form-control-sm" rows="10" readonly>{{ prompt_preview.system }}</textarea>
                    </div>
                    <div class="col-12 col-lg-8">
                      <label class="form-label small">User prompt</label>
                      <textarea class="form-control form-control-sm" rows="10" readonly>{{ prompt_preview.user }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Step 3: Edit Text & Media #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-rewrite">
        <button class="accordion-button {% if active_step != 'rewrite' %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-rewrite" aria-expanded="{% if active_step == 'rewrite' %}true{% else %}false{% endif %}" aria-controls="collapse-rewrite">
          <span class="badge text-bg-primary me-3">Шаг 3</span>
          Проверка текста и медиа
        </button>
      </h2>
      <div id="collapse-rewrite" class="accordion-collapse collapse {% if active_step == 'rewrite' %}show{% endif %}" aria-labelledby="heading-rewrite" data-bs-parent="#story-accordion">
        <div class="accordion-body">
          <form method="post" id="content-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="save" />
            <div class="mb-3">
              <label for="{{ content_form.title.id_for_label }}" class="form-label fw-semibold">{{ content_form.title.label }}</label>
              {{ content_form.title }}
            </div>
            <div class="mb-3">
              <label for="{{ content_form.body.id_for_label }}" class="form-label fw-semibold">{{ content_form.body.label }}</label>
              {{ content_form.body }}
            </div>
            <div class="d-flex justify-content-end">
              <button class="btn btn-primary" type="submit">Сохранить правки</button>
            </div>
          </form>
          <hr class="my-4" />
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <h3 class="h6 mb-0">Медиа для публикации</h3>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'stories:image' story.pk %}">
              <i class="bi bi-image me-1"></i>
              Открыть страницу изображений
            </a>
          </div>
          <p class="small text-muted mb-3">
            Добавляйте изображения из постов или генерации, выбирайте какие публиковать и какое сделать основным.
          </p>

          <ul class="nav nav-tabs" id="story-media-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="media-source-tab" data-bs-toggle="tab" data-bs-target="#media-source" type="button" role="tab" aria-controls="media-source" aria-selected="true">
                Из источников
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="media-generated-tab" data-bs-toggle="tab" data-bs-target="#media-generated" type="button" role="tab" aria-controls="media-generated" aria-selected="false">
                Сгенерированные
              </button>
            </li>
          </ul>

          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="media-source" role="tabpanel" aria-labelledby="media-source-tab">
              {% if source_media %}
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                  {% for item in source_media %}
                    <div class="col">
                      <div class="card h-100 shadow-sm">
                        <img src="{{ item.url }}" class="card-img-top" alt="Медиа поста" style="aspect-ratio: 4/3; object-fit: cover;">
                        <div class="card-body p-2 text-center">
                          <form method="post" class="d-flex flex-column gap-1">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="attach_media">
                            <input type="hidden" name="media_post_id" value="{{ item.post.id }}">
                            <button class="btn btn-sm btn-outline-primary" type="submit">
                              <i class="bi bi-plus-lg me-1"></i>
                              Добавить
                            </button>
                            <span class="small text-muted">{{ item.label }}</span>
                          </form>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="alert alert-info mb-3">
                  В исходных постах этого сюжета нет доступных изображений. Попробуйте сгенерировать
                  картинку или загрузить свою на странице «Изображение».
                </div>
              {% endif %}

              {% if source_images %}
                <h4 class="h6 mt-4">Выбранные из источников</h4>
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                  {% for image in source_images %}
                    <div class="col">
                      <div class="card h-100 shadow-sm">
                        <img src="{{ image.image_file.url }}" class="card-img-top" alt="Изображение сюжета" style="aspect-ratio: 4/3; object-fit: cover;">
                        <div class="card-body p-2 d-flex flex-column gap-1">
                          {% if image.is_main %}
                            <span class="badge text-bg-primary align-self-start">Основное</span>
                          {% endif %}
                          <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="toggle_image">
                            <input type="hidden" name="image_id" value="{{ image.id }}">
                            <input type="hidden" name="selected" value="{% if image.is_selected %}0{% else %}1{% endif %}">
                            <button class="btn btn-sm {% if image.is_selected %}btn-outline-secondary{% else %}btn-outline-primary{% endif %} w-100" type="submit">
                              {% if image.is_selected %}Убрать из публикации{% else %}В публикацию{% endif %}
                            </button>
                          </form>
                          <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="set_main_image">
                            <input type="hidden" name="image_id" value="{{ image.id }}">
                            <button class="btn btn-sm btn-outline-primary w-100" type="submit">Сделать главным</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="tab-pane fade" id="media-generated" role="tabpanel" aria-labelledby="media-generated-tab">
              {% if generated_images %}
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                  {% for image in generated_images %}
                    <div class="col">
                      <div class="card h-100 shadow-sm">
                        <img src="{{ image.image_file.url }}" class="card-img-top" alt="Сгенерированное изображение" style="aspect-ratio: 4/3; object-fit: cover;">
                        <div class="card-body p-2 d-flex flex-column gap-1">
                          {% if image.is_main %}
                            <span class="badge text-bg-primary align-self-start">Основное</span>
                          {% endif %}
                          <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="toggle_image">
                            <input type="hidden" name="image_id" value="{{ image.id }}">
                            <input type="hidden" name="selected" value="{% if image.is_selected %}0{% else %}1{% endif %}">
                            <button class="btn btn-sm {% if image.is_selected %}btn-outline-secondary{% else %}btn-outline-primary{% endif %} w-100" type="submit">
                              {% if image.is_selected %}Убрать из публикации{% else %}В публикацию{% endif %}
                            </button>
                          </form>
                          <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="set_main_image">
                            <input type="hidden" name="image_id" value="{{ image.id }}">
                            <button class="btn btn-sm btn-outline-primary w-100" type="submit">Сделать главным</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="alert alert-info">
                  Пока нет сгенерированных изображений. Перейдите на страницу «Изображение», чтобы создать их.
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Step 4: Publish #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-publish">
        <button class="accordion-button {% if active_step != 'publish' %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-publish" aria-expanded="{% if active_step == 'publish' %}true{% else %}false{% endif %}" aria-controls="collapse-publish">
          <span class="badge text-bg-primary me-3">Шаг 4</span>
          Публикация
        </button>
      </h2>
      <div id="collapse-publish" class="accordion-collapse collapse {% if active_step == 'publish' %}show{% endif %}" aria-labelledby="heading-publish" data-bs-parent="#story-accordion">
        <div class="accordion-body">
          <form method="post" id="publish-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="publish" />
            <fieldset class="p-0 m-0 border-0" {% if publish_blocked %}disabled{% endif %}>
              <div class="mb-3">
                <label for="{{ publish_form.target.id_for_label }}" class="form-label">{{ publish_form.target.label }}</label>
                {{ publish_form.target }}
              </div>
              <div class="mb-3">
                <label for="{{ publish_form.publish_at.id_for_label }}" class="form-label">{{ publish_form.publish_at.label }}</label>
                {{ publish_form.publish_at }}
              </div>
              
              {# New Media Order Section #}
              {% if main_image %}
                <div class="mb-3 border rounded p-3">
                  <label class="form-label d-block mb-2 fw-semibold">Позиция основного изображения</label>
                  <div class="d-flex align-items-start gap-3">
                    <img src="{{ main_image.image_file.url }}" alt="Основное изображение сюжета" class="rounded" style="width: 120px; height: 90px; object-fit: cover;" />
                    <div id="media_order_choices" class="pt-2">
                      {{ publish_form.media_order }}
                    </div>
                  </div>
                </div>
              {% endif %}

            </fieldset>
            <div class="d-flex justify-content-end">
              <button class="btn btn-success" type="submit" {% if publish_blocked or story.status != 'ready' and story.status != 'published' %}disabled{% endif %}>
                <i class="bi bi-send"></i> Опубликовать
              </button>
            </div>
          </form>
          <hr class="my-4" />
          <h3 class="h6">История публикаций</h3>
          {% if publications %}
            <ul class="list-group">
              {% for publication in publications %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <span class="fw-semibold">{{ publication.target }}</span>
                    <small class="text-muted d-block">
                      {% if publication.status == 'scheduled' and publication.scheduled_for %}
                        Запланировано на {{ publication.scheduled_for|date:"d.m.Y H:i" }}
                      {% else %}
                        Опубликовано {{ publication.published_at|naturaltime|default:"—" }}
                      {% endif %}
                    </small>
                  </div>
                  <span class="badge text-bg-light">{{ publication.get_status_display }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">Публикаций пока нет.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // Rewrite timer logic (preserved)
      const form = document.getElementById("rewrite-form");
      const progress = document.getElementById("rewrite-progress");
      const timerEl = progress ? progress.querySelector("[data-role='timer']") : null;
      const submitButtons = form ? form.querySelectorAll("[data-role='rewrite-submit']") : [];
      let timerId = null;

      function stopTimer() {
        if (timerId !== null) {
          clearInterval(timerId);
          timerId = null;
        }
      }

      function startTimer() {
        if (!progress || !timerEl) return;
        let seconds = 0;
        progress.classList.remove("d-none");
        timerEl.textContent = "0";
        submitButtons.forEach((button) => button.setAttribute("disabled", "disabled"));
        stopTimer();
        timerId = window.setInterval(() => {
          seconds += 1;
          timerEl.textContent = String(seconds);
        }, 1000);
      }

      if (form && progress) {
        if (progress.dataset.active === "1") {
          startTimer();
        }
        form.addEventListener("submit", (event) => {
          const submitter = event.submitter;
          if (submitter && submitter.name === "preview") return;
          startTimer();
        });
      }
      
      // Update URL with active step on accordion show
      const accordionElement = document.getElementById('story-accordion');
      if (accordionElement) {
        accordionElement.addEventListener('shown.bs.collapse', function (event) {
          const stepId = event.target.id.replace('collapse-', '');
          const url = new URL(window.location);
          url.searchParams.set("step", stepId);
          window.history.replaceState({}, "", url);
        });
      }

      // Style Bootstrap radio buttons for media_order
      const mediaOrderChoices = document.getElementById('media_order_choices');
      if (mediaOrderChoices) {
        const container = mediaOrderChoices.firstElementChild;
        if(container) {
            container.classList.add('d-flex', 'flex-column', 'gap-2');
            container.querySelectorAll('label').forEach(label => {
                label.classList.add('form-check-label');
            });
            container.querySelectorAll('input[type="radio"]').forEach(input => {
                input.classList.add('form-check-input');
            });
        }
      }
    })();
  </script>
{% endblock %}
