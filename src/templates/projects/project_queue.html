{% extends "base.html" %}
{% load humanize %}

{% block title %}Очередь коллектора — {{ project.name }}{% endblock %}

{% block content %}
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Очередь коллектора проекта «{{ project.name }}»</h1>
      <p class="text-muted mb-0">Мониторинг задач фонового сборщика.</p>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'feed-detail' project.pk %}">
      <i class="bi bi-arrow-left me-1"></i>
      К ленте проекта
    </a>
  </div>

  <div id="queue-container">
    {% include "projects/partials/task_list.html" %}
  </div>

  <script>
    (function () {
      const queueContainer = document.getElementById("queue-container");

      function refreshQueue() {
        if (document.visibilityState === "hidden") {
          return; // Don't refresh if the page is not visible
        }
        fetch(window.location.href, {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
          credentials: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to refresh queue");
            }
            return response.text();
          })
          .then((html) => {
            // Preserve scroll position if user is interacting with details
            const activeElement = document.activeElement;
            const isInteractingWithCollapse =
              activeElement &&
              (activeElement.matches('[data-bs-toggle="collapse"]') ||
                activeElement.closest(".collapse.show"));

            if (isInteractingWithCollapse) {
              return;
            }

            queueContainer.innerHTML = html;
          })
          .catch(() => {
            // Silently swallow errors to avoid disrupting the UI
          });
      }

      setInterval(refreshQueue, 15000); // Refresh every 15 seconds
    })();
  </script>
{% endblock %}
