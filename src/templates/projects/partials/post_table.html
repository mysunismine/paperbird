{% if posts %}
<table class="table table-hover align-middle mb-0">
  <thead>
    <tr>
      <th style="width: 48px;" class="text-center">
        <input type="checkbox" class="form-check-input" id="select-all-posts" />
      </th>
      <th style="width: 160px;">Дата</th>
      <th style="width: 220px;">Источник</th>
      <th>Текст</th>
    </tr>
  </thead>
  <tbody>
    {% for post in posts %}
      <tr data-post-id="{{ post.id }}">
        <td class="text-center">
          <input type="checkbox" class="form-check-input post-select" value="{{ post.id }}" />
        </td>
        <td>
          <div>{{ post.posted_at|date:"d.m.Y" }}</div>
          <div class="text-muted small">{{ post.posted_at|date:"H:i" }}</div>
        </td>
        <td>
          <div class="fw-semibold">{{ post.source.title|default:post.source.username|default:post.source.telegram_id|default:"Источник" }}</div>
          <div class="small text-muted">
            {% if post.origin_type == "telegram" %}
              Telegram ID: {{ post.telegram_id|default:"—" }}
            {% else %}
              {% if post.external_link %}
                <a href="{{ post.external_link }}" target="_blank" rel="noopener">Открыть оригинал</a>
              {% else %}
                Web: {{ post.origin_identifier|default:"—" }}
              {% endif %}
            {% endif %}
          </div>
        </td>
        <td style="max-width: 620px;">
          {% with display_text=post.display_message %}
            {% if display_text %}
              <div class="text-body">{{ display_text|truncatechars:500|linebreaksbr }}</div>
            {% else %}
              <span class="text-muted">Текст отсутствует</span>
            {% endif %}
          {% endwith %}
          {% with media_items=post.media_items %}
            {% if media_items %}
              <div class="mt-3 d-flex flex-wrap gap-2 post-media-list">
                {% for item in media_items %}
                  <a
                    href="{{ item.url }}"
                    target="_blank"
                    rel="noopener"
                    class="post-media-thumb border rounded overflow-hidden d-flex align-items-center justify-content-center"
                    style="width: 120px; height: 90px;"
                    aria-label="{% if item.kind == 'video' %}Открыть видео{% else %}Открыть изображение{% endif %}"
                  >
                    {% if item.kind == "video" %}
                      <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-body-secondary text-muted">
                        <div class="fs-2 lh-1">▶</div>
                        <div class="small fw-semibold text-uppercase">Видео</div>
                      </div>
                    {% else %}
                      <img
                        src="{{ item.url }}"
                        alt="Медиа поста"
                        loading="lazy"
                        class="img-fluid h-100 w-100 object-fit-cover"
                      />
                    {% endif %}
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          {% if post.keyword_hits %}
            <div class="small text-warning mt-1">Совпадения: {{ post.keyword_hits|join:", " }}</div>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info mb-0">В этом проекте пока нет постов. Убедитесь, что сборщик работает и источники настроены корректно.</div>
{% endif %}
