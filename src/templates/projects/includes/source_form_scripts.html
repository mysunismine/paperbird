<script>
  (function () {
    const typeSelect = document.querySelector('[data-role="source-type"]');
    if (!typeSelect) {
      return;
    }
    const sections = document.querySelectorAll("[data-source-section]");
    const importButton = document.querySelector('[data-role="preset-file-button"]');
    const fileInput = document.querySelector('[data-role="preset-file-input"]') || document.querySelector('#id_preset_file');
    const feedbackContainer = document.getElementById("preset-import-feedback");
    const payloadField = document.getElementById("id_preset_payload");

    function toggleSections() {
      const current = typeSelect.value;
      sections.forEach((section) => {
        const target = section.getAttribute("data-source-section");
        const shouldShow = !target || target === current;
        section.classList.toggle("d-none", !shouldShow);
      });
    }

    typeSelect.addEventListener("change", toggleSections);
    toggleSections();

    if (importButton && fileInput && payloadField && feedbackContainer) {
      fileInput.setAttribute("data-role", "preset-file-input");
      importButton.addEventListener("click", () => {
        fileInput.click();
      });
      fileInput.addEventListener("change", () => {
        const [file] = fileInput.files || [];
        if (!file) {
          feedbackContainer.innerHTML = "";
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          payloadField.value = reader.result || "";
          feedbackContainer.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show small p-2" role="alert">
              Импортирован файл «${file.name}»
              <button type="button" class="btn-close p-2" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          `;
        };
        reader.onerror = () => {
          feedbackContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show small p-2" role="alert">
              Не удалось прочитать файл. Попробуйте другой JSON.
              <button type="button" class="btn-close p-2" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          `;
        };
        reader.readAsText(file);
      });
    }
  })();
</script>
