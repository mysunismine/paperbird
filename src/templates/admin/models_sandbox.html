{% extends "admin/base_site.html" %}

{% block content %}
<style>
  .models-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
  .models-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 14px; }
  .models-card h3 { margin-top: 0; }
  .provider-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
  .provider-card { border: 1px solid #d6d6d6; border-radius: 8px; padding: 10px; background: #fafafa; }
  .provider-card button { margin-top: 8px; }
  .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; background: #eee; margin-left: 6px; }
  .prompt-chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 4px; }
  .prompt-chip { border: 1px solid #c6c6c6; background: #fff; border-radius: 999px; padding: 4px 10px; cursor: pointer; font-size: 12px; }
  .result-preview img { max-width: 180px; max-height: 180px; border: 1px solid #ddd; border-radius: 4px; }
  .history-item { display: flex; justify-content: space-between; font-size: 12px; color: #555; }
  .history-item + .history-item { margin-top: 6px; }
  .status-ok { color: #1a7f37; }
  .status-bad { color: #b42318; }
  @media (max-width: 1100px) {
    .models-grid { grid-template-columns: 1fr; }
  }
</style>
<div id="content-main" class="models-grid">
  <div>
    <div class="models-card">
      <h2>Настройки</h2>
      <p>Ключи отображаются в маскированном виде.</p>
      {% for section in config_sections %}
        <h3>{{ section.section }}</h3>
        <table class="adminlist">
          <thead>
            <tr>
              <th>Провайдер</th>
              <th>Модель</th>
              <th>API ключ</th>
              <th>Дополнительно</th>
            </tr>
          </thead>
          <tbody>
            {% for row in section.rows %}
              <tr>
                <td>{{ row.name }}</td>
                <td>{{ row.model }}</td>
                <td>{{ row.key }}</td>
                <td>{{ row.extra }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endfor %}
    </div>
  </div>

  <div>
    <form method="post" class="aligned models-card">
      {% csrf_token %}
      <fieldset class="module aligned" style="border: none; padding: 0; margin: 0;">
        <h2>Песочница</h2>
        <div class="provider-grid">
          {% for provider in providers %}
            <div class="provider-card">
              <strong>{{ provider.label }}</strong>
              <span class="pill">{{ provider.kind|upper }}</span>
              <button
                type="button"
                class="default"
                data-provider="{{ provider.key }}"
              >
                Проверить
              </button>
            </div>
          {% endfor %}
        </div>
        <div class="form-row" style="display: none;">
          {{ form.provider }}
        </div>
        <div class="form-row">
          {{ form.prompt.label_tag }}
          {{ form.prompt }}
          <div class="prompt-chips">
            <button class="prompt-chip" type="button" data-prompt="Верни JSON {&quot;ok&quot;: true}.">LLM: JSON OK</button>
            <button class="prompt-chip" type="button" data-prompt="Одно слово: Готово.">LLM: одно слово</button>
            <button class="prompt-chip" type="button" data-prompt="Белый квадрат на светлом фоне.">Image: simple</button>
            <button class="prompt-chip" type="button" data-prompt="Минималистичная иконка птицы, плоский стиль.">Image: icon</button>
          </div>
          <div class="help">{{ form.prompt.help_text }}</div>
        </div>
      </fieldset>
      <div class="submit-row" style="margin-top: 10px;">
        <input type="submit" value="Проверить" class="default">
      </div>
    </form>

    {% if history %}
      <div class="models-card" style="margin-top: 12px;">
        <h3>Последние проверки</h3>
        {% for item in history %}
          <div class="history-item">
            <span>
              {{ item.timestamp }} — {{ item.provider }}
              {% if item.status == "success" %}
                <span class="status-ok">OK{% if item.elapsed_ms %} · {{ item.elapsed_ms }} мс{% endif %}</span>
              {% else %}
                <span class="status-bad">Ошибка</span>
              {% endif %}
            </span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if error %}
      <div class="errornote" style="margin-top: 12px;">
        {{ error }}
      </div>
    {% elif result %}
      <div class="models-card" style="margin-top: 12px;">
        <h2>Результат</h2>
        <p><strong>{{ result.label }}</strong> — {{ result.elapsed_ms }} мс</p>
        {% if result.image_preview %}
          <div class="result-preview" style="margin: 10px 0;">
            <img
              src="data:{{ result.image_mime }};base64,{{ result.image_preview }}"
              alt="Preview"
            >
          </div>
        {% endif %}
        <details open>
          <summary>Ответ</summary>
          <pre>{{ result.payload }}</pre>
        </details>
        <details>
          <summary>Raw</summary>
          <pre>{{ result.raw }}</pre>
        </details>
      </div>
    {% endif %}
  </div>
</div>
<script>
  const providerSelect = document.getElementById('id_provider');
  const promptField = document.getElementById('id_prompt');
  document.querySelectorAll('[data-provider]').forEach((button) => {
    button.addEventListener('click', () => {
      if (providerSelect) {
        providerSelect.value = button.getAttribute('data-provider');
      }
      button.form.submit();
    });
  });
  document.querySelectorAll('[data-prompt]').forEach((button) => {
    button.addEventListener('click', () => {
      if (promptField) {
        promptField.value = button.getAttribute('data-prompt');
      }
    });
  });
</script>
{% endblock %}
