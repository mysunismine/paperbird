# Интеграция с Telethon

## 1. Общий обзор

Telethon — это асинхронная Python-библиотека для взаимодействия с Telegram API на уровне клиента. Она позволяет получать и отправлять сообщения, работать с медиафайлами, управлять чатами и пользователями. В нашем проекте Telethon используется для интеграции с Telegram, чтобы автоматически получать посты из каналов и групп, а также отправлять сообщения и медиа через аккаунт пользователя.

## 2. Авторизация и сессия

Для работы с Telethon необходимы два ключа, которые выдаёт [my.telegram.org](https://my.telegram.org):

- `api_id` — уникальный идентификатор приложения.
- `api_hash` — секретный ключ приложения.

Эти данные используются для авторизации клиента.

Сессия Telethon хранится локально в файле (например, `session.session`), что позволяет сохранять состояние между запусками и не проходить авторизацию заново. Если сессия истекает (например, из-за смены номера или удаления сессии), Telethon запросит повторную авторизацию с помощью кода из SMS или Telegram.

При ошибках подключения (timeout, неверные ключи, блокировки) библиотека выбрасывает исключения, которые необходимо обрабатывать, чтобы избежать аварийного завершения работы.

### 2.1. Мастер генерации строки сессии

В веб-интерфейсе Paperbird есть мастер «Генерация Telethon-сессии» (`/accounts/profile/telethon/`).
Он выполняет два шага:

1. Запрашивает код подтверждения для указанного телефона.
2. Принимает код (+ пароль 2FA) и сохраняет строковую сессию в профиль.

Поля `telethon_api_id` и `telethon_api_hash` должны быть заполнены до запуска мастера.
Если включить флажок «Запросить SMS», сервис выполнит повторный запрос кода через
`auth.ResendCodeRequest`. При отсутствии SMS или ограничении Telegram отобразится
сообщение «Telegram временно не может отправить SMS…» — пользователь может подождать
и повторить попытку или снять галочку SMS и подтвердить код из приложения Telegram.

### 2.2. Особенности Windows-среды

Telethon требует event loop, поддерживающий `sock_connect`. На Windows приложения по
умолчанию получают Proactor loop, где этого метода нет. Перед запуском любой
авторизации мы переключаемся на `asyncio.WindowsSelectorEventLoopPolicy`, что
исключает ситуацию, когда код подтверждения не отправляется на номер.

## 3. Подключение и инициализация клиента

Базовые шаги для подключения к Telegram API через Telethon:

1. Импортировать необходимые классы из `telethon`.
2. Создать объект клиента с использованием `api_id`, `api_hash` и файла сессии.
3. Вызвать метод `client.start()`, который автоматически выполнит авторизацию или загрузит существующую сессию.
4. Обработать возможные ошибки при подключении.

Пример инициализации:

```python
from telethon import TelegramClient

api_id = YOUR_API_ID
api_hash = 'YOUR_API_HASH'
session_file = 'session.session'

client = TelegramClient(session_file, api_id, api_hash)
await client.start()
```

## 4. Получение сообщений

Для получения сообщений из каналов и групп используется метод `client.iter_messages()` или обработчики событий `client.on(events.NewMessage)`.

- `iter_messages()` позволяет асинхронно итерироваться по историческим сообщениям.
- Для получения новых сообщений в реальном времени можно подписаться на события.

Частота опроса зависит от настроек и может быть ограничена, чтобы избежать превышения лимитов Telegram.

Для обработки ошибок и дубликатов рекомендуется:

- Использовать уникальные идентификаторы сообщений (`message.id`) для фильтрации повторов.
- Обрабатывать исключения, связанные с сетевыми сбоями.
- При необходимости реализовать повторные попытки с экспоненциальной задержкой.

## 5. Типы медиа

Telethon может возвращать следующие типы медиа в сообщениях:

- Photo — фотографии.
- Document — документы и файлы.
- Video — видеозаписи.
- Voice — голосовые сообщения.
- Audio — аудиофайлы.
- Sticker — стикеры.
- Animation — анимации (GIF).
- VideoNote — видеозаметки.

Правила сохранения:

- Медиа сохраняются в отдельные файлы с уникальными именами.
- При наличии нескольких типов медиа в одном сообщении рекомендуется сохранять все или выбирать приоритетный тип.
- Ограничения связаны с размером файлов и форматом, поддерживаемым Telegram API.

## 6. Отправка сообщений

Для отправки сообщений используются методы:

- `client.send_message()` — для текста и простых сообщений.
- `client.send_file()` — для отправки медиа (фото, видео, документы).

Если нужно отправить текст и медиа, рекомендуется разделять их на отдельные сообщения для лучшей совместимости.

Обработка ошибок включает:

- `FloodWaitError` — при превышении лимитов нужно делать паузы.
- Проверку формата и размера файлов перед отправкой.
- Логирование ошибок и повторные попытки с задержкой.

## 7. Практики безопасности

- Храните `api_id` и `api_hash` в защищённых местах (например, переменные окружения или защищённые конфигурационные файлы).
- Не выводите ключи и сессионные данные в логи.
- Регулярно обновляйте сессию, чтобы избежать истечения срока действия.
- Используйте ограниченный доступ к файлам сессии.
- Обрабатывайте исключения, чтобы предотвратить утечку данных.

## 8. Будущее расширение

В дальнейшем можно расширить интеграцию:

- Добавить поддержку ботов через Telethon или Telegram Bot API.
- Интегрировать работу с закрытыми чатами и супергруппами.
- Реализовать более сложную обработку событий и команд.
- Использовать возможности Telethon для управления контактами, каналами и статистикой.
- Добавить поддержку inline-режима и кнопок в сообщениях.

---

## 9. Текущее состояние (октябрь 2025)

- Кастомная модель пользователя хранит `api_id`, `api_hash`, строковую сессию Telethon.
- Сервис `projects.services.telethon_client.TelethonClientFactory` создаёт и проверяет авторизованный клиент.
- Команда `python manage.py collect_posts <username>` запускает сбор постов для всех активных проектов пользователя. Поддерживаются флаги `--project <id>` для выборочного сбора и `--follow --interval 30` для непрерывного мониторинга (Ctrl+C для остановки).
- Сообщения сохраняются в модели `Post` с хэшами текста/медиа и историей запусков `SourceSyncLog`.

---

Данный документ поможет быстро понять основные шаги интеграции Telethon и использовать его возможности в проекте.
