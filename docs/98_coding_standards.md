# Coding Standards

## 1. Цель  
Стандарты кода обеспечивают единый стиль разработки, ускоряют процесс ревью и позволяют автогенерировать часть работы Codex, повышая качество и поддерживаемость проекта.

## 2. Язык и докстринги  
- Все докстринги и комментарии — **обязательно** на русском языке.  
- Формат докстрингов допускается Google style или NumPy style.  
- В докстрингах обязательно описывать аргументы, возвращаемые значения, возможные исключения, а также приводить примеры использования.  
- Запрещены пустые или бессмысленные докстринги (например, `"""Функция."""` без содержания).

## 3. Статическая типизация  
- Обязательно использовать аннотации типов (PEP 484) во всех публичных функциях и классах.  
- Применяйте современный синтаксис объединений (`str | None` вместо `Optional[str]`) и общие типы из `collections.abc` там, где это возможно.  
- Рекомендуется использовать `mypy` в строгом режиме для каталогов `apps/*`.  
- Исключения из правила аннотаций должны быть минимальны и сопровождаться комментарием-пояснением с указанием причины подавления.  

## 4. Линтинг и форматирование  
- Использовать `ruff` для линтинга и форматирования.  
- После любого изменения кода и перед каждым коммитом обязательно запускать:  
  ```bash
  ruff check .
  ruff format .
  ```  
- Включить проверки: E, F, I, N, W, UP, B, ANN, PIE, COM, SIM, PTH, PL.  
- Исключить из проверки каталоги, например, `migrations/`.  
- Минимальная конфигурация `pyproject.toml`:
  ```toml
  [tool.ruff]
  select = ["E", "F", "I", "N", "W", "UP", "B", "ANN", "PIE", "COM", "SIM", "PTH", "PL"]
  exclude = ["migrations"]
  line-length = 100
  ```
  
## 5. Именование и структура кода  
- Следовать PEP 8.  
- Имена функций и переменных — `snake_case`.  
- Имена классов — `PascalCase`.  
- Константы — `UPPER_SNAKE_CASE`.  
- Максимальная длина строки — 100 символов.  
- Импорты разделять на блоки: стандартные библиотеки → сторонние → локальные.  
- Предпочитать абсолютные импорты.

## 5.1 Константы и числовые значения  
- Все «магические» числа, строки и повторяющиеся параметры выносить в общий модуль `core.constants`.  
- При добавлении новых констант используйте единый импорт из `core.constants` вместо дублирования значений по проекту.  
- Значения по умолчанию в моделях, сервисах и тестах должны ссылаться на константы, а не на литералы.

## 6. Обработка ошибок и сообщения  
- Все тексты ошибок — на русском языке, человекочитаемые.  
- В логах уровней ERROR не скрывать стек-трейсы.  
- В бизнес-логике использовать собственные исключения, избегать общих сообщений типа «Unknown error».  
- В UI показывать краткое сообщение об ошибке, подробности — в логах.

## 6.1 HTTP-статусы  
- HTTP-статусы импортируются из стандартных библиотек (`http.HTTPStatus`) либо из Django (`rest_framework.status`) и никогда не записываются числовыми литералами.  
- Исключения возможны только в случаях, когда сторонний SDK возвращает числовой код, и мы сохраняем его «как есть» (с комментарием).

## 7. Логирование  
- Логи должны быть структурированными (JSON или ключ-значение).  
- Обязательные поля: `correlation_id`, `user_id` (если есть), `project_id`, `story_id` (где применимо).  
- Использовать уровни: INFO, WARN, ERROR.  
- Запрещено использовать `print()` в продуктивном коде.

## 8. Тестирование  
- Использовать `pytest`.  
- Минимальное покрытие тестами для `apps/*` — 70%.  
- Тесты должны быть самостоятельными, с русскоязычными описаниями.  
- Фикстуры реализовывать через `factory_boy`.  
- Обязательные категории тестов: модели, сервисы, очереди/воркеры, API.

## 9. Документация (важно)  
- После каждого изменения кода обновлять всю соответствующую документацию в `docs/`.  
- В PR обязательно должен быть коммит с правками документации, если менялась логика, схемы, API, потоки или конфиги.  
- Обновлять, при необходимости:  
  - `21_data_model.md`  
  - `40_routes_api.md`  
  - `45_openapi_spec.yaml`  
  - `25_prompts_spec.md`  
  - `23_jobs_and_queues.md`  
  - `30_ui_flows.md`  
  - `31_ui_specs.md`  
  - `CHANGELOG.md` и другие.  
- В тексте PR и коммитов явно указывать, что **Codex-агент обязан сопровождать документацию**, отражая сделанные изменения.

## 10. Git и коммиты  
- Использовать Conventional Commits:  
  - `feat:` — новая функциональность  
  - `fix:` — исправление ошибок  
  - `docs:` — изменения документации  
  - `refactor:` — рефакторинг  
  - `test:` — добавление/изменение тестов  
  - `chore:` — прочие задачи  
- Сообщения коммитов — на русском языке.  
- Один коммит — одна логическая правка.  
- В описании PR указывать: что сделано, почему и какие документы обновлены.

## 11. Pre-commit  
- Рекомендуется настроить `pre-commit` с хуками:  
  - `ruff check` и `ruff format`  
  - `mypy`  
  - `pytest -q` (быстрые тесты)  
  - `forbid-credentials` (запрет коммитить секреты)  
- Пример `.pre-commit-config.yaml` (краткий):
  ```yaml
  repos:
    - repo: https://github.com/charliermarsh/ruff-pre-commit
      rev: v0.0.241
      hooks:
        - id: ruff
          args: [--fix]
    - repo: https://github.com/pre-commit/mirrors-mypy
      rev: v1.2.0
      hooks:
        - id: mypy
    - repo: https://github.com/pre-commit/mirrors-pytest
      rev: v7.4.0
      hooks:
        - id: pytest
          args: [-q]
    - repo: https://github.com/Yelp/detect-secrets
      rev: v1.0.3
      hooks:
        - id: forbid-credentials
  ```

## 12. Проверочный чеклист перед PR  
- [ ] Запущен линтер (`ruff check .`) без ошибок  
- [ ] Отформатирован код (`ruff format .`)  
- [ ] Пройден `mypy` без ошибок (или есть комментарии с объяснением)  
- [ ] Запущены тесты, покрытие не ниже 70%  
- [ ] Обновлена документация, если менялась логика  
- [ ] Обновлен `CHANGELOG.md`, если есть изменения  
- [ ] Миграции применяются и протестированы (если есть)

## 13. Модели Django
- Все ограничения по длинам и повторяющиеся значения выносите в модуль с константами; не дублируйте «магические» числа в полях.
- Каждому полю задавайте `verbose_name` (и `help_text`, если требуется пояснение).
- В `Meta` указывайте `verbose_name`/`verbose_name_plural`; для постраничных моделей обязательно задавайте `ordering`.
- Каждая не абстрактная модель должна реализовывать информативный `__str__`.
- Внешние ключи объявляйте с явным `related_name`.
- После добавления модели регистрируйте её в админке.
