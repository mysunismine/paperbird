

# Модель данных проекта Paperbird

## 1. Обзор модели данных

Архитектура данных проекта построена вокруг пользователей (User), их проектов (Project) и источников контента (Source), из которых загружаются посты (Post). Посты могут быть объединены в истории (Story), подвергаться обработке (RewriteJob), а затем публиковаться (Publication) и дополняться сгенерированными изображениями (AIImage). Система поддерживает управление статусами, связями между сущностями и хранением данных.

## 2. Сущности и их поля

### User
- **id** (UUID / Integer): Уникальный идентификатор пользователя.
- **email** (String): Email пользователя (уникальный).
- **name** (String): Имя пользователя.
- **created_at** (Datetime): Дата регистрации.
- **is_active** (Boolean): Активен ли пользователь.

### Project
- **id** (UUID / Integer): Уникальный идентификатор проекта.
- **user_id** (FK -> User): Владелец проекта.
- **title** (String): Название проекта.
- **description** (String): Описание проекта.
- **created_at** (Datetime): Дата создания.

### Source (Канал или чат)
- **id** (UUID / Integer): Уникальный идентификатор источника.
- **project_id** (FK -> Project): Проект, к которому относится источник.
- **type** (Enum: 'channel', 'chat'): Тип источника.
- **external_id** (String): Внешний id (например, Telegram channel_id).
- **title** (String): Название источника.
- **is_active** (Boolean): Активен ли источник.

### Post
- **id** (UUID / Integer): Уникальный идентификатор поста.
- **source_id** (FK -> Source): Источник поста.
- **channel_id** (String): Внешний id канала.
- **message_id** (String/Integer): Внешний id сообщения.
- **text** (Text): Текст поста.
- **media_url** (String): Ссылка на медиа (если есть).
- **created_at** (Datetime): Дата публикации поста в источнике.
- **fetched_at** (Datetime): Дата загрузки в систему.
- **status** (Enum): Статус обработки (см. ниже).
- **story_id** (FK -> Story, nullable): Связанная история (если есть).

### Story
- **id** (UUID / Integer): Уникальный идентификатор истории.
- **project_id** (FK -> Project): Проект, к которому относится история.
- **title** (String): Название истории.
- **summary** (Text): Краткое описание/аннотация.
- **status** (Enum): Статус истории (см. ниже).
- **created_at** (Datetime): Дата создания.

### RewriteJob
- **id** (UUID / Integer): Уникальный идентификатор задачи.
- **post_id** (FK -> Post): Пост, который обрабатывается.
- **requested_by** (FK -> User): Кто инициировал задачу.
- **status** (Enum): Статус задачи (см. ниже).
- **result_text** (Text): Итоговый текст.
- **created_at** (Datetime): Дата создания.
- **finished_at** (Datetime, nullable): Дата завершения.

### Publication
- **id** (UUID / Integer): Уникальный идентификатор публикации.
- **story_id** (FK -> Story): История для публикации.
- **published_at** (Datetime, nullable): Дата публикации.
- **status** (Enum): Статус публикации (см. ниже).
- **external_url** (String, nullable): Ссылка на опубликованный материал.

### AIImage
- **id** (UUID / Integer): Уникальный идентификатор изображения.
- **story_id** (FK -> Story): История, к которой относится изображение.
- **url** (String): Ссылка на изображение.
- **prompt** (Text): Промпт для генерации.
- **created_at** (Datetime): Дата генерации.

## 3. Связи между сущностями

- **User 1:N Project:** Один пользователь может иметь несколько проектов.
- **Project 1:N Source:** Один проект содержит несколько источников.
- **Source 1:N Post:** Один источник содержит множество постов.
- **Project 1:N Story:** Один проект содержит несколько историй.
- **Post N:1 Story:** Пост может быть привязан к одной истории (или не привязан).
- **Story 1:N Publication:** Одна история может иметь несколько публикаций (например, в разные каналы).
- **Post 1:N RewriteJob:** Один пост может иметь несколько задач на обработку.
- **Story 1:N AIImage:** Одна история может иметь несколько связанных AI-изображений.

## 4. Статусы и состояния

| Сущность      | Статусы                                      |
|-------------- |----------------------------------------------|
| Post          | `new`, `processing`, `ready`, `archived`, `error` |
| Story         | `draft`, `in_progress`, `ready`, `published`, `archived` |
| RewriteJob    | `pending`, `in_progress`, `done`, `failed`   |
| Publication   | `pending`, `scheduled`, `published`, `failed`|

## 5. Индексы и уникальные ограничения

- **Post:** Уникальный индекс на `(channel_id, message_id)` — для предотвращения дублирования постов из одного источника.
- **User:** Уникальный индекс по `email`.
- **Source:** Уникальный индекс на `(project_id, external_id)` — один источник в проекте.
- **AIImage:** Индекс по `story_id` для ускорения выборки изображений по истории.
- **RewriteJob:** Индекс по `post_id`.

## 6. Правила хранения и очистки

- **Посты (Post):** Хранятся не менее 90 дней с момента загрузки. После этого могут быть помечены как `archived` и удалены при необходимости.
- **Медиафайлы:** Ссылки на медиа удаляются сразу после удаления поста или по истечении срока хранения, если медиа не используются в историях/публикациях.
- **Истории (Story), публикации (Publication), AI-изображения (AIImage):** Хранятся бессрочно, если не удалены пользователем.
- **После очистки:** Метаданные о действиях (например, логи RewriteJob) могут сохраняться для аудита, но текст постов и медиа удаляются полностью.