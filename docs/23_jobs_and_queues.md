# Jobs & Queues

## 1. Общий обзор

В проекте используются фоновые задачи и очереди для асинхронной обработки длительных и ресурсоёмких операций. Очереди позволяют разгрузить основной поток, повысить отказоустойчивость и масштабируемость. Воркеры обрабатывают задачи из очередей, обеспечивая параллелизм и контроль над выполнением.

Очередь реализована через модели `core.WorkerTask` и `core.WorkerTaskAttempt`. Каждая задача хранит полезную нагрузку, статус, счётчик попыток, политику ретраев и временную метку доступности. Все попытки выполнения логируются в отдельной таблице, что упрощает аудит и отладку.

Сервисный слой (`core.services.worker`) предоставляет:

- `enqueue_task()` — постановка задач с учётом очередных настроек;
- `WorkerRunner` — цикл обработки с батчевым резервированием и повторным запуском;
- `TaskExecutionError` — единый способ сигнализировать о повторной попытке или фатальной ошибке;
- регистр обработчиков (`register_handler`, `get_handler`) для связывания очереди и бизнес-логики.

Запуск воркеров выполняется через команду `python manage.py run_worker <queue>` с поддержкой параметров `--handler`, `--worker-id`, `--batch-size`, `--sleep`, `--once`.

## 2. Collector (Сборщик постов)

**Задачи:** сбор новых постов из внешних источников.  
**Частота запуска:** периодически, согласно расписанию (например, cron).  
**Поведение при ошибках:** при сбоях задача ретраится с экспоненциальным бэком оффом.  
**Дедупликация:** предотвращается повторная обработка одних и тех же постов по уникальным идентификаторам, а также по содержимому при совпадении текста и медиа.  
**Проверка состояния сессии Telethon:** перед выполнением задачи проверяется состояние сессии; при обнаружении проблем выполняется до 3 попыток переподключения, после чего задача фиксируется с ошибкой.  
**Поведение при блокировке Telegram (rate limit):** при получении ограничений со стороны Telegram происходит логирование события и отправка уведомления пользователю о блокировке и необходимости ожидания.  
**Ретраи:** настроены с ограничением по количеству попыток.  
**Логирование:** фиксируются успешные сборы, ошибки, количество собранных постов, а также события переподключения и блокировок.
**Режимы:** 
- разовый — `python manage.py collect_posts <username> [--project ID] --limit 50`; 
- непрерывный — `python manage.py collect_posts <username> --follow --interval 30`, запускает цикл опроса с указанным интервалом и останавливается по Ctrl+C.

## 3. RewriteWorker (Рерайтер)

**Создание задач:** задачи на рерайт создаются после успешного сбора постов.  
**Взаимодействие с OpenAI:** отправляются запросы на генерацию текста с учётом контекста.  
**Ретраи при невалидном JSON:** если ответ OpenAI невалиден, задача повторяется с ограничением в 3 попытки.  
**Уведомление пользователя:** при ошибках модели и повторных попытках пользователь информируется о том, что происходит повтор из-за ошибки генерации.  
**Обрезание текста:** если сгенерированный текст превышает лимит по длине, он автоматически обрезается до допустимого размера.  
**Превышение лимита токенов:** если задача превышает лимит токенов, она помечается как failed с соответствующим пояснением в логах и уведомлением пользователя.  
**Обработка ошибок:** ошибки API и парсинга логируются, при критических ошибках задача отклоняется.  
**Логирование:** фиксируются запросы, ответы, ошибки, статусы рерайта и уведомления.

## 4. Publisher (Публикатор)

**Задачи:** отправка сообщений и медиа в целевые каналы или чаты.  
**Поведение при FLOOD_WAIT и других ошибках:** при ошибках Telegram API, таких как FLOOD_WAIT, задача ретраится с учётом указанного времени ожидания.  
**Плановая публикация:** если Telegram недоступен во время плановой публикации, задача повторяется вручную через заданный интервал N секунд.  
**Ручной перезапуск:** предусмотрена возможность ручного перезапуска публикации через административную панель.  
**Отмена всей публикации:** при критических ошибках публикация всего пакета сообщений отменяется для предотвращения неконсистентности.  
**Статусы при ошибках:** если публикация не удалась, задача помечается статусом `failed`, а пользователю отправляется уведомление с причиной.  
**Логирование:** фиксируются успешные публикации, ошибки и причины отмены, а также события ручного перезапуска.

## 5. ImageGenerator (Генератор изображений)

**Задачи:** генерация изображений по запросам из задач рерайта или публикации.  
**Сохранение:** сохраняются только изображения, прикреплённые к постам.  
**Удаление:** неиспользуемые или устаревшие изображения удаляются для экономии места. Также предусмотрена возможность удаления сгенерированного изображения, если оно не прикреплено к посту.  
**Поведение при ошибке генерации:** при ошибках генерации выполняется до 3 повторных попыток, после чего задача помечается как `failed`.  
**Логирование:** фиксируются успешные генерации, ошибки, операции удаления и повторные попытки.

## 6. Maintenance (Очистка проектов)

**Очередь:** `maintenance` (резервные задачи обслуживания).  
**Назначение:** автоматическое удаление постов, вышедших за пределы срока хранения в настройках проекта.  
**Постановка задач:** `python manage.py schedule_retention_cleanup [--project <id>] [--delay <minutes>]` — добавляет задачи в очередь для всех активных проектов или выбранного проекта, опционально откладывая исполнение.  
**Обработчик:** `projects.workers.retention_cleanup_task` вызывает сервис `purge_expired_posts`, пропуская сюжеты с активными связями и возвращая количество удалённых постов.  
**Запуск воркера:** `python manage.py run_worker maintenance` (можно запускать в supervisor/systemd). Для ручной проверки доступна команда `python manage.py purge_expired_posts --dry-run`.

### Source Metadata (очередь `source`)

- **Назначение:** обновление сведений об источниках (название, username, peer id) после добавления или изменения через Telethon.  
- **События:** постановка задач выполняется автоматически при сохранении/редактировании источника (см. `projects.services.source_metadata.enqueue_source_refresh`).  
- **Обработчик:** `projects.workers.refresh_source_metadata_task` получает entity через Telethon и обновляет модель `Source`.  
- **Запуск:** `python.manage.py run_worker source --sleep 10` (можно запустить параллельно с остальными воркерами).

## 7. Очереди и приоритеты

- **collector_queue:** задачи сбора постов, средний приоритет.  
- **rewrite_queue:** задачи рерайта, высокий приоритет.  
- **publish_queue:** задачи публикации, высокий приоритет с контролем частоты.  
- **imagegen_queue:** задачи генерации изображений, низкий приоритет.  

Каждая очередь обрабатывается параллельно несколькими воркерами с ограничением количества одновременных задач, которое задаётся через конфигурационный файл. Также предусмотрена возможность ручной остановки и запуска очередей через административную панель.

## 8. Ретраи и таймауты

- **Ретраи:** задаются в полях задачи (`max_attempts`, `base_retry_delay`, `max_retry_delay`) и рассчитываются как экспоненциальный 2^n backoff.  
- **Настройка:** параметры каждой очереди описаны в `QUEUE_DEFAULTS`, при необходимости их можно переопределять при постановке задач.  
- **Таймауты:** базовые значения для OpenAI запросов (например, 30 секунд), Telethon (Telegram API) — 60 секунд, публикации — 45 секунд.  
- **Конфигурация:** все параметры ретраев и таймаутов настраиваются через `.env` файл для гибкого управления.

## 9. Мониторинг и логирование

- **Что логируем:** статусы задач (успех, ошибка, повтор), детали ошибок, время выполнения, количество ретраев.  
- **Статусы задач:** отслеживаются состояния: queued, running, succeeded, failed, cancelled.  
- **Уведомления:** при превышении числа ошибок за единицу времени отправляются уведомления ответственным лицам для оперативного реагирования.  
- **Метрики:** собираются и анализируются среднее время выполнения задач, среднее количество ретраев, доля неудачных задач.  
- **Доступность:** статусы задач и метрики доступны в административной панели (`WorkerTask`, `WorkerTaskAttempt`) и через API для интеграции и мониторинга.  
- **Где отображаем:** логи доступны в централизованной системе логирования и в административной панели для оперативного мониторинга и отладки.
