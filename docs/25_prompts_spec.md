# Prompts Specification

## 1. Цель и назначение

Промпты используются для взаимодействия с моделями OpenAI и другими LLM не только для рерайта новостей, но и для решения широкого спектра задач: генерации заголовков, создания пояснений, формирования ключевых слов, генерации изображений и других видов контента. Их основная задача — задать модели контекст и инструкции, чтобы получить качественный, стилистически выверенный и адаптированный под требования редакции или продукта результат. Промпты позволяют управлять стилем, структурой и содержанием итогового вывода, обеспечивая единообразие и соответствие заданным стандартам.

## 2. Структура промпта

Промпт должен состоять из следующих частей в фиксированном порядке:

1. **Системный промпт** — задаёт общий контекст и правила работы модели.
2. **Документы** — исходные тексты, передаваемые как отдельные блоки.
3. **Комментарий редактора** — дополнительные указания, влияющие на стиль и содержание.
4. **Формат ответа** — описание желаемой структуры и формата итогового вывода.

Каждая часть должна быть чётко сформулирована, лаконична и однозначна. Не рекомендуется смешивать инструкции разных частей или использовать двусмысленные формулировки. Это обеспечивает корректное восприятие модели и повышает качество результата.

## 3. Системный промпт

Системный промпт задаёт тон, стиль и общие правила для работы модели. Рекомендуется придерживаться следующих правил:

- Длина: не более 3-5 предложений, чтобы избежать перегрузки модели.
- Тон: формальный, нейтральный, соответствующий задаче (например, деловой стиль для новостей).
- Стиль: чёткий и однозначный, без сложных или двусмысленных выражений.
- Не использовать запреты в негативной форме (например, «не делайте так»), лучше — позитивные инструкции («делайте так»).

**Пример хорошего системного промпта:**

```
Вы — профессиональный редактор новостей. Ваша задача — переписать исходный текст так, чтобы он был лаконичным, информативным и соответствовал стилю деловой журналистики. Избегайте повторов, уточняйте факты и сохраняйте нейтральный тон.
```

**Пример плохого системного промпта:**

```
Не повторяй слова, не делай текст длинным, не добавляй свои мысли, не используй сленг.
```

## 4. Документы

Исходные тексты (посты) всегда передаются как отдельные блоки, каждый из которых должен быть явно маркирован уникальным идентификатором, например, `#1`, `#2` и так далее. Это помогает модели ориентироваться в исходных данных и сохранять порядок.

Каждый блок должен быть заключён в тройные обратные кавычки (```) для сохранения форматирования.

Пример:

```
#1
```
Оригинальный текст новости №1
```

#2
```
Оригинальный текст новости №2
```
```

## 5. Комментарий редактора

Комментарий редактора — это текстовое указание, которое помогает модели понять дополнительные требования к рерайту или другой задаче. Он влияет на стиль, тон и содержание итогового текста и имеет приоритет ниже системного промпта, то есть не отменяет базовые правила, но уточняет их.

Рекомендуемая длина комментария — до 3-5 предложений, чтобы не перегружать модель.

Пример комментария:

- «Сделайте текст более формальным и избегайте жаргона.»
- «Добавьте пояснения к техническим терминам.»
- «Сократите объём, сохраняя ключевые факты.»

## 6. Формат ответа

Ответ модели должен быть в строго валидном формате JSON, соответствующем заданной схеме. Основные требования:

- JSON должен быть корректным и без синтаксических ошибок.
- Все ключи, предусмотренные схемой, должны присутствовать всегда.
- Если значение отсутствует, использовать пустую строку `""`.
- Структура должна быть согласована с фронтендом и другими системами, использующими ответ.
- Пример расширенной схемы:

```json
{
  "title": "Переписанный заголовок новости",
  "summary": "Краткое резюме новости",
  "content": "Основной текст новости, отредактированный и адаптированный",
  "hashtags": ["новости", "экономика", "технологии"],
  "sources": ["Источник 1", "Источник 2"]
}
```

## 7. Валидация и ретраи

При получении невалидного JSON необходимо предпринять до 3 повторных попыток получения корректного ответа:

- При каждом повторном запросе обязательно добавить уточнение о необходимости строго соблюдать формат JSON и схему.
- Если после трёх попыток ответ остаётся некорректным, необходимо уведомить пользователя о проблеме и предложить изменить промпт или уточнить инструкцию.

## 8. Ограничения по длине

Общий размер промпта и входных данных не должен превышать лимит токенов модели (например, 4096 токенов для GPT-3.5). Рекомендуется:

- Подсчитывать токены и при необходимости усекать документы, сохраняя ключевые части.
- В промпте добавить указание модели быть короче, если ожидается длинный ответ.

Пример подсказки:

```
Пожалуйста, сформируйте ответ максимально кратко, сохраняя все ключевые факты.
```

## 9. Пресеты и конфигурация

Промпты могут храниться в виде пресетов для быстрого переключения между стилями и задачами. Структура пресета включает:

- Имя пресета
- Описание
- Стиль изложения
- Максимальная длина ответа
- Формат вывода
- Пример использования

Пример JSON-пресета:

```json
{
  "name": "business_news_rewrite",
  "description": "Переписывание новостей в деловом стиле",
  "style": "деловой, формальный, нейтральный",
  "max_length_tokens": 1000,
  "output_format": {
    "title": "string",
    "summary": "string",
    "content": "string",
    "hashtags": "array",
    "sources": "array"
  },
  "example": {
    "title": "Компания X объявила о новом продукте",
    "summary": "Компания X представила инновационный продукт, который изменит рынок.",
    "content": "Сегодня компания X официально представила новый продукт...",
    "hashtags": ["технологии", "продукт", "компания X"],
    "sources": ["Официальный сайт компании X"]
  }
}
```

## 10. Обработка невалидного ответа

В случае получения невалидного ответа или ошибки:

- Попытаться повторить запрос с уточнением формата (до 3 раз).
- Если повторные попытки не увенчались успехом — вывести сообщение об ошибке пользователю.
- Рекомендовать ручное редактирование промпта или уточнение инструкции.
- В случае системных ошибок или некорректного поведения модели использовать fallback-промпты или уведомлять оператора.

## 11. Расширенные рекомендации

**Для системного промпта:**

- Используйте позитивные формулировки.
- Чётко указывайте роль и задачу модели.
- Избегайте избыточных или противоречивых инструкций.
- Держите длину в разумных пределах.

**Для документов:**

- Передавайте каждый документ отдельно с уникальным идентификатором.
- Сохраняйте оригинальное форматирование.
- Обеспечьте логический порядок блоков.

**Для комментариев редактора:**

- Используйте ясные и конкретные глаголы: «сделайте», «добавьте», «исключите».
- Указывайте конкретные цели и ограничения.
- Избегайте двусмысленностей и слишком общих фраз.
- Ограничивайте длину, чтобы не перегружать модель.

---

Этот документ поможет быстро понять, как строятся промпты для взаимодействия с LLM, как управлять их поведением для получения качественного результата и как обрабатывать возможные ошибки.
