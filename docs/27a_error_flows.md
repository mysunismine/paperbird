# Error Handling & Recovery Flows

## 1. Обзор

Данный документ описывает сценарии возникновения ошибок в системе, реакцию на них, а также действия, предпринимаемые воркерами и пользователями для восстановления работы. Цель — обеспечить устойчивость и предсказуемость обработки ошибок, минимизировать влияние сбоев на пользовательский опыт и поддерживать прозрачность процессов.

## 2. Классификация ошибок

Ошибки в системе делятся на следующие логические категории:

- **Ошибки интеграций**  
  Ошибки, возникающие при взаимодействии с внешними сервисами и API: Telethon, Telegram API, OpenAI API.

- **Ошибки в данных**  
  Некорректные или неполные данные: невалидный JSON, превышение лимитов, пустой ответ.

- **Ошибки публикации**  
  Проблемы при отправке сообщений или медиа: сообщение слишком длинное, медиа слишком большое, сетевые ошибки.

- **Ошибки генерации изображений**  
  Сбои при генерации изображений через API: ошибки API, некорректные запросы, таймауты.

- **Системные ошибки**  
  Внутренние сбои: таймауты, отсутствие соединения, сбой воркера.

## 3. Общие принципы обработки

- Все ошибки логируются с подробным контекстом задачи, включая `correlation_id` и сопутствующие данные.
- Пользователь всегда получает человекочитаемое сообщение на русском языке, объясняющее суть ошибки.
- Повторные попытки выполняются автоматически там, где это технически возможно и оправдано.
- Если задача не может быть выполнена автоматически, она переводится в статус `failed`, и пользователь уведомляется о необходимости вмешательства.

## 4. Потоки обработки по категориям

### Telethon / Telegram API

- **FLOOD_WAIT**  
  Задача замораживается на период ожидания, ошибка логируется, пользователь получает уведомление. Для разблокировки требуется ручной перезапуск.

- **SessionExpired**  
  Выполняется до 3 попыток переподключения. Если все неудачны — задача переводится в статус `failed`, пользователь уведомляется.

- **RateLimitExceeded**  
  Используется экспоненциальный backoff с максимум 3 попытками повторения. При неудаче — статус `failed` и уведомление пользователя.

### OpenAI API / LLM

- **InvalidJSON**  
  Выполняется до 3 повторных попыток генерации. Пользователь информируется о проблеме с указанием на источник ошибки.

- **Timeout**  
  Производится 3 попытки повторного запроса. При неудаче — задача `failed`.

- **ContentPolicyViolation**  
  Ошибка приводит к немедленному переводу задачи в статус `failed`. Пользователь получает соответствующее сообщение.

- **TokenLimitExceeded**  
  Текст автоматически обрезается до лимита, пользователь уведомляется о сокращении.

### Публикация

- **MessageTooLong**  
  Сообщение не отправляется. Пользователь уведомляется и может отредактировать текст вручную.

- **MediaTooLarge**  
  Публикация отменяется, ошибка отображается в UI.

- **NetworkError**  
  Выполняется до 3 повторных попыток отправки. При неудаче — задача `failed`.

- **ChannelNotFound**  
  Немедленный перевод задачи в статус `failed`. Пользователь проверяет настройки канала.

### Генерация изображений

- **APIError**  
  Выполняется до 3 повторов запроса. При неудаче — `failed`.

- **InvalidPrompt**  
  Задача сразу переводится в статус `failed` без повторов. Редактор уведомляется для исправления комментария.

- **GenerationTimeout**  
  Повтор запроса выполняется с экспоненциальным backoff, максимум 3 раза.

## 5. Действия пользователя и UI

- Ошибки отображаются в виде компактных плашек с краткой информацией.
- Если задача находится в статусе `failed`, UI предлагает пользователю следующие действия: повторить задачу, отредактировать данные, проверить настройки.
- Все действия пользователя (повтор, правка и прочее) логируются для последующего анализа.

## 6. Мониторинг и алерты

- При превышении порога количества ошибок одного типа автоматически отправляется уведомление администратору системы.
- Ведутся метрики по следующим показателям: количество ошибок по типу, процент успешных повторных попыток, среднее время восстановления после ошибки.
