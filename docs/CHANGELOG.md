

# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/), and this project adheres to [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Added
- Публичные страницы для опубликованных историй (`/public/`, `/public/<project_id>/`, `/public/<project_id>/p/<publication_id>/`) с отдельными шаблонами и стилями.
- Включение публичной витрины на уровне проекта через настройки (`public_enabled`, `public_noindex`, `public_title`).
- Каталог публичных проектов на `/public/` с подсчётом опубликованных историй.
- Поддержка `gpt-5o` и `gemini-1.5-flash` в выборе моделей рерайта.
- Явные настройки генерации изображений по провайдерам (`OPENAI_IMAGE_*`, `YANDEX_IMAGE_*`) и новые переменные окружения.
- Песочница в админке `/admin/models/` для проверки моделей и API ключей с историей запусков.
- Поддержка Gemini Images (`gemini-2.5-flash-image`, `gemini-3-pro-image-preview`) и переменные окружения `GEMINI_IMAGE_*`.
- На страницу генерации изображений (`stories/<id>/image/`) добавлена возможность загружать собственные файлы с компьютера через drag-and-drop.
- На страницу смены пароля (`accounts/password/change/`) добавлен индикатор надёжности пароля в реальном времени и переключатели видимости для полей ввода.
- В предпросмотре промпта на странице сюжета добавлена подсветка синтаксиса для ключевых разделов (`[ЗАДАНИЕ]`) и элементов (`НОВОСТЬ #1`), что значительно улучшает читаемость.
- Добавлен экспорт настроек проекта в JSON/YAML без выгрузки постов, включая источники и снимки пресетов.
- На странице изображений появился рекомендованный промпт, который генерируется через LLM и настраивается в промптах проекта.
- Добавлен импорт шаблонов промпта проекта из JSON/YAML, включая промпт для идеи изображения.
- Добавлена поддержка нескольких изображений на сюжет с выбором главного и списка для публикации.

### Changed
- Для генерации изображений настройки разделены по провайдерам OpenAI/Yandex, дефолты берутся из `settings`.
- В UI генерации и в настройках проекта отображаются только параметры, актуальные для выбранной модели.
- **(UI/UX)** Полностью переработан дизайн страницы генерации изображений (`stories/<id>/image/`). Теперь это двухколоночный «Image Studio» с вкладками («Генерация», «Медиа из постов», «Загрузить») и единой областью предпросмотра. Генерация изображений теперь происходит асинхронно (AJAX) без перезагрузки страницы.
- **(UI/UX)** Улучшен процесс использования рекомендованного промпта на странице генерации изображений: автоматическая загрузка при открытии страницы, более понятные кнопки действий.
- **(UI/UX)** Реализована асинхронная (AJAX) загрузка изображений на страницу генерации через Drag-and-Drop и выбор файла.
- **(UI/UX)** Асинхронное (AJAX) добавление изображений из постов в предпросмотр на странице генерации для дальнейшего прикрепления.
- **(UI/UX)** Предпросмотр промпта оставлен внутри карточки сюжета, отдельная страница промпта убрана.
- **(UI/UX)** В карточку сюжета добавлена явная ссылка на страницу изображений.
- **(UI/UX)** Рекомендованный промпт для изображений генерируется по кнопке, с мягкой обработкой ошибок.
- **(UI/UX)** Превью изображения уменьшено, а полноразмерный просмотр открывается по клику.
- **(UI/UX)** Переработан дизайн страницы смены пароля (`accounts/password/change/`) в более современный вид с использованием карточки.
- **(UI/UX)** Исправлен цвет текста индикатора надёжности пароля для лучшей читаемости.
- **(UI/UX)** Обновлён дизайн формы создания источника (`projects/<id>/sources/create/`). Теперь это двухэтапный процесс: сначала пользователь выбирает тип источника («Telegram» или «Веб-сайт»), после чего отображаются соответствующие поля.
- **(UI/UX)** Улучшена обратная связь при импорте пресетов в форме создания источника: вместо текста теперь используются Bootstrap-уведомления.
- **(UI/UX)** Улучшен дизайн формы создания проекта (`projects/create/`). Форма организована в виде вкладок («Основные», «Генерация контента», «Сбор и хранение») для лучшей навигации.
- **(UI/UX)** Стабилизирована высота контента вкладок формы создания проекта, предотвращая «прыгание» элементов при переключении.
- **(UI/UX)** Реализовано асинхронное (AJAX) прикрепление медиа из исходных постов к сюжету без перезагрузки страницы.
- URL-адрес для создания сюжета из постов переименован с `stories/create/` на `stories/actions/create-from-posts/`, чтобы его назначение было более очевидным.

### Fixed
- Исправлена ошибка, из-за которой при автоматическом обновлении ленты постов (`feed`) вместо нового интерфейса с карточками отображался старый табличный UI.
- Удалён неиспользуемый шаблон `post_table.html`.
- Исправлены ошибки генерации изображений для разных моделей за счёт корректного маппинга качества и размеров.
- Обновлены параметры качества OpenAI Images до `low/medium/high/auto`.
- Устранена ошибка `RequestDataTooBig` при прикреплении сгенерированного изображения.
- Исправлена ошибка публикации, вызванная обращением к ORM из async-контекста.

### Added
- Реализовано автоматическое добавление в промпт текущей даты и времени на основе настроек локали и часового пояса проекта.
- Реализован модуль аутентификации: кастомный пользователь Django, страницы входа и профиль с полями Telethon.
- Модели проектов/источников/постов и команда `collect_posts` для сбора контента через Telethon.
- Режим `collect_posts --all-users`, позволяющий запускать сборщик сразу для всех пользователей с настроенными Telethon-ключами.
- Расширенные фильтры постов, поиск по ключевым словам и сводка совпадений.
- Пресеты рерайта, выбор инструкций в UI и сохранение последнего использованного пресета.
- Базовые страницы интерфейса: список проектов, лента постов, карточка сюжета и история публикаций.
- Структурированное логирование с идентификаторами корреляции и пользовательская страница ошибки 500.
- Авторазблокировка «зависших» задач в воркерах и дополнительное логирование `worker_batch_processed`, чтобы отслеживать холостые прогоны и количество реанимированных задач.
- Веб-коллектор теперь ставит отдельные задачи на каждый источник, пропуская уже запланированные, и поддерживает индивидуальные retry-настройки (`web_retry_*`) на уровне источника.
- Импорт пресетов автоматически пересохраняет `web_preset_snapshot` у всех связанных источников, поэтому новые заголовки/селекторы вступают в силу сразу.
- Документация обновлена: `docs/23_jobs_and_queues.md` описывает автоанлок, параллелизм и кастомные ретраи; `docs/60_web_preset_guide.md` фиксирует автообновление снапшотов.

### Changed
- Веб-коллектор умеет собирать изображения по нескольким селекторам сразу и убирает дубли; JSON Schema и `docs/60_web_preset_guide.md` дополнились рекомендациями по фотогалереям и смешанным форматам.

### Fixed
- Пресет `ria_animals` извлекает полный текст и фотографии фотолент (`.photoview__desc-text`, `data-photoview-src`), поэтому в ленте снова видны параграфы и иллюстрации.
- Пресет `izvestia_zhivotnye` расширен: контент берётся и из `text-article__inside`, а изображения подхватываются из `data-src` (включая hero-блок), поэтому новости вроде «Предпрофессиональный экзамен…» больше не обрезаются до одного заголовка.

## [0.1.0] – MVP (предстоящий релиз)

### Added
- Авторизация и управление пользователями
- Интеграция с Telethon и сбор постов
- Хранение постов и фильтрация
- Создание сюжетов и отправка в OpenAI
- Публикация постов в Telegram
- Базовый WebUI
- Воркеры и обработка ошибок

## [0.2.0] – Beta (запланировано)

### Added
- Расширенные фильтры и ключевые слова
- Пресеты рерайта и комментарии
- Отложенные публикации
- Генерация изображений
- Логирование и экран ошибок

## [0.3.0] – v1.0 (будущее)

### Added
- CI/CD и автоматическое тестирование
- Улучшенная безопасность и хранение ключей
- Аналитика и статистика
- Дополнительные источники контента
