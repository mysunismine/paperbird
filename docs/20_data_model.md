

# Data Model

## 1. Обзор

Этот документ описывает основную структуру данных системы Paperbird. Здесь представлены ключевые сущности, их поля, связи между ними и примеры данных. Документ предназначен для разработчиков и аналитиков, чтобы быстро понять, как устроена модель данных, и использовать её для разработки, интеграции и поддержки системы.

## 2. Список сущностей

- **User** — пользователь системы, его профиль, настройки и ключи доступа к Telethon.
- **Project** — рабочий проект пользователя, включает источники, фильтры и параметры сбора.
- **Source** — отслеживаемый Telegram-канал или чат, из которого собирается контент.
- **Post** — отдельный пост, собранный из Telegram.
- **Story** — сюжет, объединяющий один или несколько постов по смыслу.
- **RewriteTask** — задача на рерайтинг поста или сюжета.
- **Publication** — результат публикации подготовленного материала.
- **Image** — сгенерированное изображение для публикации.

## 3. Модели и поля

### User
| Поле        | Тип            | Обяз. | Описание                                 |
|-------------|----------------|-------|-------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор пользователя     |
| username    | str            | да    | Имя пользователя                         |
| email       | str            | да    | Email пользователя                       |
| settings    | JSON/dict      | нет   | Настройки профиля                        |
| telethon_api_id     | str     | нет   | API ID для Telethon                      |
| telethon_api_hash   | str     | нет   | API Hash для Telethon                    |
| telethon_session    | str     | нет   | Сессия Telethon                          |
| created_at  | datetime       | да    | Дата создания                            |

### Project
| Поле                          | Тип            | Обяз. | Описание                                                          |
|-------------------------------|----------------|-------|-------------------------------------------------------------------|
| id                            | UUID / int     | да    | Уникальный идентификатор проекта                                  |
| owner_id                      | UUID / int     | да    | Владелец (User)                                                   |
| name                          | str            | да    | Название проекта                                                  |
| description                   | str            | нет   | Описание                                                          |
| is_active                     | bool           | да    | Активен ли проект                                                 |
| publish_target                | str            | нет   | Целевой канал для публикации (например, @my_channel)              |
| locale                        | str            | да    | Локаль для форматирования даты и времени (например, ru_RU)        |
| time_zone                     | str            | да    | Часовой пояс проекта (например, Europe/Moscow)                    |
| rewrite_model                 | str            | да    | Модель GPT для рерайта                                            |
| image_model                   | str            | да    | Модель для генерации изображений                                  |
| image_size                    | str            | да    | Размер генерируемых изображений                                   |
| image_quality                 | str            | да    | Качество генерируемых изображений                                 |
| public_enabled                | bool           | да    | Включена ли публичная витрина проекта                             |
| public_noindex                | bool           | да    | Запрет индексации публичных страниц                               |
| public_title                  | str            | нет   | Публичное название проекта                                        |
| retention_days                | int            | да    | Срок хранения постов в днях                                       |
| collector_enabled             | bool           | да    | Включен ли сборщик постов                                         |
| collector_telegram_interval   | int            | да    | Интервал опроса Telegram-источников в секундах                    |
| collector_web_interval        | int            | да    | Интервал запуска веб-парсера в секундах                           |
| collector_last_run            | datetime       | нет   | Время последнего запуска сборщика                                 |
| created_at                    | datetime       | да    | Дата создания                                                     |
| updated_at                    | datetime       | да    | Дата последнего обновления                                        |

### Source
| Поле        | Тип            | Обяз. | Описание                                    |
|-------------|----------------|-------|----------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор источника           |
| project_id  | UUID / int     | да    | Связанный проект (Project)                   |
| type        | str            | да    | Тип источника (channel, chat)                |
| title       | str            | да    | Название канала/чата                        |
| username    | str            | нет   | Username канала/чата                        |
| external_id | str            | да    | Внешний идентификатор (например, Telegram id)|
| created_at  | datetime       | да    | Дата добавления                              |

### Post
| Поле        | Тип            | Обяз. | Описание                                   |
|-------------|----------------|-------|---------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор поста              |
| source_id   | UUID / int     | да    | Источник (Source)                           |
| external_id | str            | да    | Внешний id поста (в Telegram)               |
| text        | str            | нет   | Текст поста                                 |
| media       | JSON/list      | нет   | Мультимедиа (ссылки, описания)              |
| published_at| datetime       | да    | Дата публикации                             |
| created_at  | datetime       | да    | Дата сбора                                  |

### Story
| Поле        | Тип            | Обяз. | Описание                                   |
|-------------|----------------|-------|---------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор сюжета             |
| project_id  | UUID / int     | да    | Проект (Project)                            |
| title       | str            | да    | Название сюжета                             |
| summary     | str            | нет   | Краткое описание сюжета                     |
| post_ids    | JSON/list      | да    | Список id постов, входящих в сюжет          |
| created_at  | datetime       | да    | Дата создания                               |

### RewriteTask
| Поле        | Тип            | Обяз. | Описание                                   |
|-------------|----------------|-------|---------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор задачи             |
| story_id    | UUID / int     | да    | Сюжет (Story)                               |
| post_id     | UUID / int     | нет   | Пост (Post), если задача на отдельный пост  |
| status      | str            | да    | Статус задачи (pending, in_progress, done)  |
| result_text | str            | нет   | Результат рерайта                           |
| created_at  | datetime       | да    | Дата создания                               |
| updated_at  | datetime       | нет   | Дата обновления                             |

### Publication
| Поле        | Тип            | Обяз. | Описание                                   |
|-------------|----------------|-------|---------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор публикации         |
| story_id    | UUID / int     | да    | Сюжет (Story)                               |
| result_text | str            | да    | Текст публикации                            |
| images      | JSON/list      | нет   | Список id изображений                       |
| published_at| datetime       | нет   | Дата публикации                             |
| target      | str            | да    | Куда опубликовано (платформа, канал и т.д.) |

### Image
| Поле        | Тип            | Обяз. | Описание                                   |
|-------------|----------------|-------|---------------------------------------------|
| id          | UUID / int     | да    | Уникальный идентификатор изображения        |
| publication_id | UUID / int  | да    | Публикация (Publication)                    |
| url         | str            | да    | URL сгенерированного изображения            |
| description | str            | нет   | Описание/альтернативный текст               |
| created_at  | datetime       | да    | Дата создания                               |

## 4. Связи между сущностями

- **User** 1 — *N* **Project**: Один пользователь может иметь несколько проектов.
- **Project** 1 — *N* **Source**: В проекте может быть несколько источников.
- **Source** 1 — *N* **Post**: Один источник содержит множество постов.
- **Project** 1 — *N* **Story**: В проекте может быть несколько сюжетов.
- **Story** 1 — *N* **Post**: Один сюжет состоит из одного или нескольких постов (ManyToMany, обычно через список id).
- **Story** 1 — *N* **RewriteTask**: На один сюжет может быть несколько задач рерайта.
- **RewriteTask** (опционально) связан с **Post** (если задача на отдельный пост).
- **Story** 1 — *N* **Publication**: Один сюжет может быть опубликован несколько раз.
- **Publication** 1 — *N* **Image**: Одна публикация может содержать несколько изображений.

## 5. Диаграмма (текстовая)

```
User
 └── Project (N)
       ├── Source (N)
       │     └── Post (N)
       └── Story (N)
             ├── [Post] (N, связь через список id)
             ├── RewriteTask (N)
             │      └── (опционально) Post
             └── Publication (N)
                    └── Image (N)
```

## 6. Примеры данных

### User
```json
{
  "id": "f8c1a2b4-1234-4f6c-9a01-111111111111",
  "username": "ivan",
  "email": "ivan@example.com",
  "settings": {"theme": "dark"},
  "telethon_api_id": "123456",
  "telethon_api_hash": "abcdef1234567890",
  "telethon_session": "session-string",
  "created_at": "2024-05-01T10:00:00Z"
}
```

### Project
```json
{
  "id": "a1b2c3d4-5678-4e5f-8a2b-222222222222",
  "user_id": "f8c1a2b4-1234-4f6c-9a01-111111111111",
  "name": "Новости ИТ",
  "description": "Сбор новостей из Telegram-каналов",
  "locale": "ru_RU",
  "time_zone": "Europe/Moscow",
  "publish_target": "@it_news_channel",
  "created_at": "2024-05-01T11:00:00Z"
}
```

### Source
```json
{
  "id": "c9d8e7f6-3333-4b2a-9f8e-333333333333",
  "project_id": "a1b2c3d4-5678-4e5f-8a2b-222222222222",
  "type": "channel",
  "title": "IT News",
  "username": "itnews",
  "external_id": "1234567890",
  "created_at": "2024-05-01T11:05:00Z"
}
```

### Post
```json
{
  "id": "d4c3b2a1-4444-4e5f-8a2b-444444444444",
  "source_id": "c9d8e7f6-3333-4b2a-9f8e-333333333333",
  "external_id": "54321",
  "text": "Вышел новый релиз Python!",
  "media": [{"type": "image", "url": "https://..."}],
  "published_at": "2024-05-01T12:00:00Z",
  "created_at": "2024-05-01T12:01:00Z"
}
```

### Story
```json
{
  "id": "e5f6a7b8-5555-4c3b-9a0f-555555555555",
  "project_id": "a1b2c3d4-5678-4e5f-8a2b-222222222222",
  "title": "Релиз Python 3.12",
  "summary": "Все новости о релизе Python 3.12",
  "post_ids": [
    "d4c3b2a1-4444-4e5f-8a2b-444444444444"
  ],
  "created_at": "2024-05-01T13:00:00Z"
}
```

### RewriteTask
```json
{
  "id": "f7e8d9c0-6666-4a2b-8f9e-666666666666",
  "story_id": "e5f6a7b8-5555-4c3b-9a0f-555555555555",
  "post_id": "d4c3b2a1-4444-4e5f-8a2b-444444444444",
  "status": "done",
  "result_text": "Вышел новый Python 3.12 с улучшениями.",
  "created_at": "2024-05-01T14:00:00Z",
  "updated_at": "2024-05-01T14:10:00Z"
}
```

### Publication
```json
{
  "id": "aabbccdd-7777-4b2a-9f8e-777777777777",
  "story_id": "e5f6a7b8-5555-4c3b-9a0f-555555555555",
  "result_text": "Python 3.12 вышел! Главные фичи: ...",
  "images": [
    "bbccddeeff-8888-4b2a-9f8e-888888888888"
  ],
  "published_at": "2024-05-01T15:00:00Z",
  "target": "tg_channel:mychannel"
}
```

### Image
```json
{
  "id": "bbccddeeff-8888-4b2a-9f8e-888888888888",
  "publication_id": "aabbccdd-7777-4b2a-9f8e-777777777777",
  "url": "https://images.example.com/python312.png",
  "description": "Логотип Python 3.12",
  "created_at": "2024-05-01T14:59:00Z"
}
```
